{"version":3,"sources":["docs/js/app.js"],"names":["app","angular","module","config","$routeProvider","$locationProvider","when","title","templateUrl","controller","resolve","user","User","isLoggedOrGoTo","html5Mode","$httpProvider","defaults","withCredentials","run","$rootScope","$route","$routeParams","$window","$q","$timeout","closeModal","modal","index","forEach","modals","m","i","active","splice","standalone","navigator","$on","current","value","key","replace","RegExp","document","log","console","info","apply","arguments","addModal","modalType","params","deferred","defer","template","data","this","reject","push","window","scrollTo","promise","$scope","FirebaseService","$location","State","state","ready","model","submit","busy","signin","then","response","success","$$lastRequestedPath","error","$interval","Hash","Calendar","GanttRow","serializeDate","date","pad","v","s","z","length","Array","join","yyyy","getFullYear","MM","getMonth","dd","getDate","hh","getHours","mm","getMinutes","ss","getSeconds","getRandomDay","Date","setDate","Math","floor","random","setHours","setMinutes","setSeconds","ceil","getTime","mKey","getRandomItem","day","item","id","uid","hours","activityId","row","taskId","prototype","slice","call","activity","name","budgetHours","project","type","deliveryDate","addItem","slots","add","update","updateMonths","updateItem","extend","clearItems","ranges","removeAll","months","days","intervalId","start","stop","cancel","constant","ACTIVITY","CUSTOMER","DEPARTMENT","GROUP","MANAGER","PROJECT","RESOURCE","USER","factory","pool","get","Object","defineProperties","enumerable","writable","has","undefined","getId","hash","set","newItem","p","keys","remove","oldItem","indexOf","addMany","items","removeMany","shift","each","callback","forward","reverse","sort","c","d","a","b","backward","differs","t","updatePool","pools","ArrayFrom","len","today","todayKey","clearMonth","month","tasks","fromDay","getDay","monthDays","weeks","r","$today","getKey","ganttGroups","colors","assignedHours","useBudget","customer","department","manager","resource","color","lastTaskId","canSelect","canEdit","toLowerCase","mergeSlot","slot","insertSlot","min","max","removeSlots","toggleSlots","assign","col","$key","$date","write","erase","toggle","total","copy","task","updateRanges","previous","lastDay","rKey","range","getRange","from","to","firstKey","lastKey","updateRange","previousKey","nextKey","n","canMoveRange","dir","can","first","getOffsetKey","startDate","k","moveRange","addDays","toggleOpened","opened","compress","Utils","where","serialNumber","number","toString","directive","$http","$templateCache","$compile","_format","string","prepend","expression","splitted","split","formatted","templateFunction","element","attributes","form","placeholder","aid","formKey","formFocus","message","decoration","disabled","label","change","onChange","focus","onFocus","blur","onBlur","inputCols","cols","colInput","colLabel","required","readonly","options","validate","format","precision","ngDisabled","controlRow","match","validation","click","mouseover","mouseout","icon","nameHi","formKeyHi","modelHi","validationHi","requiredHi","messageHi","decorationHi","himodel","filter","optionLabel","source","canCreate","flatten","queryable","onSelected","rows","taDisabled","restrict","compile","templateElement","templateAttributes","scope","html","contents","$parse","transclude","link","onRemove","e","getter","numberPicker","setter","onAdd","removeListeners","nodeRemove","off","nodeAdd","node","querySelectorAll","on","$filter","require","$modelValue","$setViewValue","doBlur","$invalid","validateType","$formatters","$parsers","unshift","valid","String","Number","$setValidity","isReady","idle","isBusy","isError","isErroring","isSuccess","isSuccessing","button","errors","enabled","bind","errorMessage","submitClass","successing","errorring","submitMessage","idleMessage","busyMessage","successMessage","storage","Api","redirect","btoa","JSON","stringify","un","userName","pwd","password","path","q","auth","sso","signout","delete","service","_service","onPresences","onActivities","userId","$firebaseAuth","$firebaseObject","$firebaseArray","getConfig","apiKey","authDomain","databaseURL","projectId","storageBucket","messagingSenderId","firebase","initializeApp","$user","firstName","lastName","timestamp","now","$signInAnonymously","remember","logged","catch","getPresences","fs","root","database","ref","presencesRef","child","userRef","snap","val","onDisconnect","updateUser","presences","removeRange","firebaseArray","$keyAt","$ref","clearActivities","POSITIVE_INFINITY","presence","activities","addActivities","lastActivity","activitiesRef","getUniqueActivities","getActivities","lastDate","NEGATIVE_INFINITY","$loaded","Cookie","TIMEOUT","_set","setTime","expires","toGMTString","cookie","cache","json","cookieName","ca","charAt","substring","parse","checkCookie","elapsed","timeout","interval","setTimeout","LocalStorage","isSupported","supported","localStorage","setItem","removeItem","storageEvent","clearTimeout","originalEvent","newValue","SessionStorage","sessionStorage"],"mappings":"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","file":"app.min.js","sourcesContent":["/* global angular */\r\n\r\n\"use strict\";\r\n\r\nvar app = angular.module('app', ['ngRoute', 'firebase', 'jsonFormatter']);\r\n\r\napp.config(['$routeProvider', '$locationProvider', function($routeProvider, $locationProvider) {\r\n\r\n    $routeProvider.when('/', {\r\n        title: 'Homepage',\r\n        templateUrl: 'partials/home.html',\r\n        controller: 'HomeCtrl',\r\n\r\n    }).when('/signin', {\r\n        title: 'Accedi',\r\n        templateUrl: 'partials/signin.html',\r\n        controller: 'SigninCtrl',\r\n\r\n    }).when('/user/:userId', {\r\n        title: 'User',\r\n        templateUrl: 'partials/user.html',\r\n        controller: 'UserCtrl',\r\n        resolve: {\r\n            user: ['User', function(User) {\r\n                return User.isLoggedOrGoTo('/signin');\r\n            }],\r\n        },\r\n\r\n    }).when('/404', {\r\n        title: 'Error 404',\r\n        templateUrl: 'partials/404',\r\n\r\n    });\r\n\r\n    // $routeProvider.otherwise('/'); // stream\r\n\r\n    // HTML5 MODE url writing method (false: #/anchor/use, true: /html5/url/use)\r\n    $locationProvider.html5Mode(false);\r\n\r\n}]);\r\n\r\napp.config(['$httpProvider', function($httpProvider) {\r\n    $httpProvider.defaults.withCredentials = true;\r\n}]);\r\n\r\napp.run(['$rootScope', '$route', '$routeParams', '$window', '$q', '$timeout', function($rootScope, $route, $routeParams, $window, $q, $timeout) {\r\n\r\n    $rootScope.standalone = $window.navigator.standalone;\r\n\r\n    $rootScope.$on('$routeChangeSuccess', function() {\r\n        var title = $route.current.title;\r\n        angular.forEach($routeParams, function(value, key) {\r\n            title = title.replace(new RegExp(':' + key, 'g'), value);\r\n        });\r\n        document.title = title || '';\r\n    });\r\n\r\n    $rootScope.log = function() {\r\n        if (console && console.info) {\r\n            console.info.apply(console, arguments);\r\n        }\r\n    };\r\n\r\n    // MODALS\r\n    $rootScope.modals = [];\r\n\r\n    function closeModal(modal) {\r\n        var index = -1;\r\n        angular.forEach($rootScope.modals, function(m, i) {\r\n            if (m === modal) {\r\n                index = i;\r\n            }\r\n        });\r\n        if (index !== -1) {\r\n            modal.active = false;\r\n            $timeout(function() {\r\n                $rootScope.modals.splice(index, 1);\r\n            }, 500);\r\n        }\r\n    };\r\n    $rootScope.addModal = function(modalType, title, params) {\r\n        var deferred = $q.defer();\r\n        params = params || null;\r\n        var modal = {\r\n            title: 'Untitled',\r\n            controller: null,\r\n            template: null,\r\n            params: params,\r\n        }\r\n        switch (modalType) {\r\n            case 'messageModal':\r\n                modal = {\r\n                    title: title || 'Messaggio',\r\n                    controller: 'MessageModalCtrl',\r\n                    template: 'partials/modals/message',\r\n                    params: params,\r\n                }\r\n                break;\r\n        }\r\n        modal.deferred = deferred;\r\n        modal.resolve = function(data) {\r\n            closeModal(this);\r\n            modal.deferred.resolve(data, modal);\r\n        }\r\n        modal.reject = function() {\r\n            closeModal(this);\r\n            modal.deferred.reject(modal);\r\n        }\r\n        $rootScope.modals.push(modal);\r\n        angular.forEach($rootScope.modals, function(m, i) {\r\n            m.active = false;\r\n        });\r\n        $timeout(function() {\r\n            modal.active = true;\r\n            window.scrollTo(0, 0);\r\n        }, 500);\r\n        return deferred.promise;\r\n    };\r\n\r\n}]);\n/* global angular, app */\r\n\n/* global angular, app */\r\n\r\napp.controller('RootCtrl', ['$scope', 'FirebaseService', function($scope, FirebaseService) {\r\n\r\n    function ___InitFirebase() {\r\n        var user = {\r\n\r\n        };\r\n\r\n        var service = $scope.service = new FirebaseService({\r\n            onPresences: function(items) {\r\n                console.log('GanttCtrl.onPresences', items.length);\r\n                gantt.onPresences(items);\r\n            },\r\n            onActivities: function(items) {\r\n                console.log('GanttCtrl.onActivities', items.length);\r\n                gantt.onActivities(items);\r\n            }\r\n        });\r\n        service.signin(user).then(function() {\r\n            /*\r\n            service.getPresences().then(function() {\r\n                service.getActivities().then(function() {\r\n                    console.log('GanttCtrl.FirebaseService.ready');\r\n                });\r\n            });\r\n            */\r\n        });\r\n        /*\r\n        $scope.$on('onGanttInsert', function(scope, items) {\r\n            console.log('GanttCtrl.onGanttInsert', items.length);\r\n            items = items.map(function(item) {\r\n                var item = angular.copy(item);\r\n                return item;\r\n            });\r\n            service.addActivities(items);\r\n        });\r\n        $scope.$on('onGanttUpdate', function(scope, items) {\r\n            console.log('GanttCtrl.onGanttUpdate', items.length);\r\n            items = items.map(function(item) {\r\n                var item = angular.copy(item);\r\n                return item;\r\n            });\r\n            service.addActivities(items);\r\n        });\r\n        $scope.$on('onGanttRemove', function(scope, items) {\r\n            console.log('GanttCtrl.onGanttRemove', items.length);\r\n            items = items.map(function(item) {\r\n                var item = angular.copy(item);\r\n                item.hours = 0;\r\n                return item;\r\n            });\r\n            service.addActivities(items);\r\n        });\r\n        */\r\n    }\r\n\r\n    // InitFirebase();\r\n\r\n}]);\r\n\r\napp.controller('HomeCtrl', ['$scope', '$location', '$timeout', 'State', function($scope, $location, $timeout, State) {\r\n\r\n    var state = $scope.state = new State();\r\n\r\n    state.ready();\r\n\r\n}]);\r\n\r\napp.controller('SigninCtrl', ['$scope', '$location', '$timeout', 'State', 'User', function($scope, $location, $timeout, State, User) {\r\n\r\n    var state = $scope.state = new State();\r\n\r\n    var model = $scope.model = {};\r\n\r\n    $scope.submit = function() {\r\n        if (state.busy()) {\r\n            User.signin(model).then(function success(response) {\r\n                state.success();\r\n                console.log('SigninCtrl', $location.$$lastRequestedPath || '/');\r\n                /*\r\n                $timeout(function() {\r\n                    console.log('SigninCtrl', $location.$$lastRequestedPath || '/');\r\n                    $location.path($location.$$lastRequestedPath || '/');\r\n                    $location.$$lastRequestedPath = null;\r\n                }, 1000);\r\n                */\r\n            }, function error(response) {\r\n                console.log('SigninCtrl.error', response);\r\n                state.error(response);\r\n            });\r\n        }\r\n    }\r\n\r\n}]);\r\n\r\napp.controller('DemoCtrl', ['$scope', '$interval', 'Hash', 'Calendar', 'GanttRow', function($scope, $interval, Hash, Calendar, GanttRow) {\r\n\r\n    var row = $scope.row = new GanttRow({\r\n        activity: {\r\n            id: 1000000 + getRandom(),\r\n            name: 'Activity',\r\n            budgetHours: 10 + Math.floor(Math.random() * 50),\r\n        },\r\n        project: {\r\n            type: Math.floor(Math.random() * 5),\r\n            deliveryDate: new Date(),\r\n        },\r\n    }, []);\r\n\r\n    $scope.addItem = function() {\r\n        var item = getRandomItem();\r\n        row.slots.add(item);\r\n        row.update();\r\n        row.updateMonths();\r\n        $scope.item = item;\r\n        // console.log('addItem', item.id);\r\n        log('addItem', item.id);\r\n    };\r\n    $scope.updateItem = function() {\r\n        if ($scope.item) {\r\n            var id = $scope.item.id;\r\n            item = getRandomItem();\r\n            item = angular.extend($scope.item, item);\r\n            item.id = id;\r\n            row.slots.add(item);\r\n            row.update();\r\n            row.updateMonths();\r\n            $scope.item = item;\r\n            log('updateItem', item.id);\r\n        }\r\n    };\r\n    $scope.clearItems = function() {\r\n        row.ranges.removeAll();\r\n        row.months.removeAll();\r\n        row.days.removeAll();\r\n        row.slots.removeAll();\r\n        row.update();\r\n        row.updateMonths();\r\n        delete $scope.item;\r\n        log('clearItems');\r\n    };\r\n\r\n    var intervalId;\r\n    $scope.start = function() {\r\n        $scope.stop();\r\n        intervalId = $interval($scope.addItem, 1000 / 60);\r\n    };\r\n    $scope.stop = function() {\r\n        if (intervalId) {\r\n            $interval.cancel(intervalId);\r\n        }\r\n    };\r\n\r\n    function serializeDate(date) {\r\n        function pad(v, s, z) {\r\n            v = (v || 0) + '';\r\n            s = (s || 2);\r\n            z = (z || '0');\r\n            return v.length >= s ? v : new Array(s - v.length + 1).join(z) + v;\r\n        }\r\n        var yyyy = date.getFullYear();\r\n        var MM = date.getMonth() + 1; // getMonth() is zero-based\r\n        var dd = date.getDate();\r\n        var hh = date.getHours();\r\n        var mm = date.getMinutes();\r\n        var ss = date.getSeconds();\r\n        return yyyy + '-' + pad(MM) + '-' + pad(dd) + 'T' + pad(hh) + ':' + pad(mm) + ':' + pad(ss);\r\n    }\r\n\r\n    function getRandom() {\r\n        return 1000000 + Math.floor(Math.random() * 100000);\r\n    }\r\n\r\n    function getRandomDay() {\r\n        const oneday = (24 * 60 * 60 * 1000);\r\n        var date = new Date();\r\n        date.setDate(date.getDate() + Math.floor(Math.random() * 60));\r\n        // date.setMonth(date.getMonth() + Math.floor(Math.random() * 2));\r\n        date.setHours(0);\r\n        date.setMinutes(0);\r\n        date.setSeconds(0);\r\n        var yyyy = date.getFullYear();\r\n        var MM = date.getMonth();\r\n        var key = Math.ceil(date.getTime() / oneday);\r\n        var mKey = yyyy * 12 + MM;\r\n        return {\r\n            key: key,\r\n            mKey: mKey,\r\n            date: serializeDate(date)\r\n        };\r\n    }\r\n\r\n    var uid = 1;\r\n\r\n    function getRandomItem() {\r\n        var day = getRandomDay();\r\n        var item = {\r\n            id: uid,\r\n            hours: 1 + Math.floor(Math.random() * 6),\r\n            date: new Date(day.date),\r\n            key: day.key,\r\n            mKey: day.mKey,\r\n            activityId: row.id,\r\n        };\r\n        if (Math.floor(Math.random() * 3) == 0) {\r\n            item.taskId = 10000 + Math.floor(Math.random() * 50);\r\n        }\r\n        uid++;\r\n        return item;\r\n    }\r\n\r\n    function log() {\r\n        $scope.log = Array.prototype.slice.call(arguments);\r\n    }\r\n}]);\r\n\r\n\r\napp.constant('ganttGroups', {\r\n    ACTIVITY: 1,\r\n    CUSTOMER: 2,\r\n    DEPARTMENT: 3,\r\n    GROUP: 4,\r\n    MANAGER: 5,\r\n    PROJECT: 6,\r\n    RESOURCE: 7,\r\n    USER: 9,\r\n});\r\n\r\napp.factory('Hash', [function() {\r\n    var pools = {};\r\n\r\n    function Hash(key, pool) {\r\n        key = key || 'id';\r\n        pool = pool ? Hash.get(pool) : {};\r\n        Object.defineProperties(this, {\r\n            key: {\r\n                value: key,\r\n                enumerable: false,\r\n                writable: false\r\n            },\r\n            pool: {\r\n                value: pool,\r\n                enumerable: false,\r\n                writable: false\r\n            },\r\n            length: {\r\n                value: 0,\r\n                enumerable: false,\r\n                writable: true\r\n            }\r\n        });\r\n    }\r\n\r\n    function has(id) {\r\n        return this.pool[id] !== undefined;\r\n    }\r\n\r\n    function getId(id) {\r\n        return this.pool[id];\r\n    }\r\n\r\n    function get(item) {\r\n        var hash = this,\r\n            key = this.key;\r\n        return item ? hash.getId(item[key]) : null;\r\n    }\r\n\r\n    function set(item) {\r\n        var hash = this,\r\n            pool = this.pool,\r\n            key = this.key;\r\n        pool[item[key]] = item;\r\n        hash.push(item);\r\n        return item;\r\n    }\r\n\r\n    function add(newItem) {\r\n        var hash = this;\r\n        var item = hash.get(newItem);\r\n        if (item) {\r\n            for (var i = 0, keys = Object.keys(newItem), p; i < keys.length; i++) {\r\n                p = keys[i];\r\n                item[p] = newItem[p];\r\n            }\r\n        } else {\r\n            item = hash.set(newItem);\r\n        }\r\n        return item;\r\n    }\r\n\r\n    function remove(oldItem) {\r\n        var hash = this,\r\n            pool = this.pool,\r\n            key = this.key;\r\n        var item = hash.get(oldItem);\r\n        if (item) {\r\n            var index = hash.indexOf(item);\r\n            if (index !== -1) {\r\n                hash.splice(index, 1);\r\n            }\r\n            delete pool[item[key]];\r\n        }\r\n        return hash;\r\n    }\r\n\r\n    function addMany(items) {\r\n        var hash = this;\r\n        if (!items) {\r\n            return hash;\r\n        }\r\n        var i = 0;\r\n        while (i < items.length) {\r\n            hash.add(items[i]);\r\n            i++;\r\n        }\r\n        return hash;\r\n    }\r\n\r\n    function removeMany(items) {\r\n        var hash = this;\r\n        if (!items) {\r\n            return hash;\r\n        }\r\n        var i = 0;\r\n        while (i < items.length) {\r\n            hash.remove(items[i]);\r\n            i++;\r\n        }\r\n        return hash;\r\n    }\r\n\r\n    function removeAll() {\r\n        var hash = this,\r\n            key = hash.key,\r\n            pool = hash.pool;\r\n        var i = 0,\r\n            t = hash.length,\r\n            item;\r\n        while (hash.length) {\r\n            item = hash.shift();\r\n            delete pool[item[key]];\r\n            i++;\r\n        }\r\n        return hash;\r\n    }\r\n\r\n    function each(callback) {\r\n        var hash = this;\r\n        if (callback) {\r\n            var i = 0;\r\n            while (i < hash.length) {\r\n                callback(hash[i], i);\r\n                i++;\r\n            }\r\n        }\r\n        return hash;\r\n    }\r\n\r\n    function forward(key, reverse) {\r\n        var hash = this,\r\n            key = (key || this.key);\r\n        hash.sort(function(c, d) {\r\n            var a = reverse ? d : c;\r\n            var b = reverse ? c : d;\r\n            return a[key] - b[key];\r\n        });\r\n        return hash;\r\n    }\r\n\r\n    function backward(key) {\r\n        return this.forward(key, true);\r\n    }\r\n\r\n    function differs(hash) {\r\n        if (hash.key !== this.key || hash.length !== this.length) {\r\n            return true;\r\n        } else {\r\n            var differs = false,\r\n                i = 0,\r\n                t = this.length,\r\n                key = this.key;\r\n            while (differs && i < t) {\r\n                differs = this[i][key] !== hash[i][key];\r\n                i++;\r\n            }\r\n        }\r\n    }\r\n\r\n    function updatePool() {\r\n        var hash = this,\r\n            pool = this.pool,\r\n            key = this.key;\r\n        Object.keys(pool).forEach(function(key) {\r\n            delete pool[key];\r\n        });\r\n        angular.forEach(hash, function(item) {\r\n            pool[item[key]] = item;\r\n        });\r\n    }\r\n    Hash.get = function(pool) {\r\n        return pools[pool] = (pools[pool] || {});\r\n    };\r\n    Hash.prototype = new Array;\r\n    Hash.prototype.has = has;\r\n    Hash.prototype.getId = getId;\r\n    Hash.prototype.get = get;\r\n    Hash.prototype.set = set;\r\n    Hash.prototype.add = add;\r\n    Hash.prototype.remove = remove;\r\n    Hash.prototype.each = each;\r\n    Hash.prototype.addMany = addMany;\r\n    Hash.prototype.removeMany = removeMany;\r\n    Hash.prototype.removeAll = removeAll;\r\n    Hash.prototype.forward = forward;\r\n    Hash.prototype.backward = backward;\r\n    Hash.prototype.differs = differs;\r\n    Hash.prototype.updatePool = updatePool;\r\n    return Hash;\r\n}]);\r\n\r\napp.factory('Calendar', ['Hash', function(Hash) {\r\n    const oneday = (24 * 60 * 60 * 1000);\r\n    var today = new Date();\r\n    today.setHours(0);\r\n    today.setMinutes(0);\r\n    today.setSeconds(0);\r\n    var todayKey = Math.ceil(today.getTime() / oneday);\r\n\r\n    function ArrayFrom(len, callback) {\r\n        var a = [];\r\n        while (a.length < len) {\r\n            a.push(callback(a.length));\r\n        }\r\n        return a;\r\n    };\r\n    var months = new Hash('mKey');\r\n\r\n    function Calendar() {}\r\n    Calendar.getDate = function(day) {\r\n        if (typeof day.date.getMonth === 'function') {\r\n            return day.date;\r\n        } else {\r\n            return new Date(day.date);\r\n        }\r\n    };\r\n    Calendar.clearMonth = function(month) {\r\n        month.days.each(function(day) {\r\n            if (day) {\r\n                day.hours = 0;\r\n                day.tasks = [];\r\n            }\r\n        });\r\n    };\r\n    Calendar.getMonth = function(day) {\r\n        today = new Date();\r\n        today.setHours(0);\r\n        today.setMinutes(0);\r\n        today.setSeconds(0);\r\n        todayKey = Math.ceil(today.getTime() / oneday);\r\n        //\r\n        var date = Calendar.getDate(day);\r\n        var yyyy = date.getFullYear();\r\n        var MM = date.getMonth();\r\n        var key = Math.ceil(date.getTime() / oneday);\r\n        var mKey = yyyy * 12 + MM;\r\n        var month = months.getId(mKey);\r\n        if (!month) {\r\n            var fromDay = new Date(yyyy, MM, 1).getDay();\r\n            var monthDays = new Date(yyyy, MM + 1, 0).getDate();\r\n            var weeks = Math.ceil(monthDays / 7);\r\n            var month = {\r\n                date: date,\r\n                mKey: mKey,\r\n                month: MM,\r\n                monthDays: monthDays,\r\n                fromDay: fromDay,\r\n                days: new Hash('key'),\r\n            };\r\n            month.weeks = ArrayFrom(weeks, function(r) {\r\n                var days = ArrayFrom(7, function(c) {\r\n                    var item = null;\r\n                    var d = r * 7 + c - (fromDay - 1);\r\n                    if (d >= 0 && d < monthDays) {\r\n                        var date = new Date(yyyy, MM, d + 1);\r\n                        var key = Math.ceil(date.getTime() / oneday);\r\n                        item = {\r\n                            $today: key === todayKey,\r\n                            c: c,\r\n                            r: r,\r\n                            d: d + 1,\r\n                            date: date,\r\n                            key: key,\r\n                            hours: 0,\r\n                            tasks: [],\r\n                        };\r\n                        item = month.days.add(item);\r\n                    }\r\n                    return item;\r\n                });\r\n                return {\r\n                    r: r,\r\n                    days: days,\r\n                }\r\n            });\r\n            month = months.add(month);\r\n        }\r\n        return month;\r\n    };\r\n    Calendar.getDay = function(days) {\r\n        var date = new Date(today);\r\n        date.setDate(date.getDate() + days);\r\n        return date;\r\n    };\r\n    Calendar.getKey = function(date) {\r\n        return Math.ceil(date.getTime() / oneday);\r\n    };\r\n    return Calendar;\r\n}]);\r\n\r\napp.factory('GanttRow', ['Hash', 'Calendar', 'ganttGroups', function(Hash, Calendar, ganttGroups) {\r\n    var uid = 1;\r\n\r\n    const oneday = (24 * 60 * 60 * 1000);\r\n    var today = new Date();\r\n    today.setHours(0);\r\n    today.setMinutes(0);\r\n    today.setSeconds(0);\r\n    var todayKey = Math.ceil(today.getTime() / oneday);\r\n\r\n    function GanttRow(data, colors) {\r\n        this.type = ganttGroups.ACTIVITY;\r\n        this.assignedHours = 0;\r\n        this.slots = new Hash('id');\r\n        this.days = new Hash('key');\r\n        this.months = new Hash('mKey');\r\n        this.ranges = new Hash('rKey');\r\n        this.tasks = new Hash('id'); // 'taskId'\r\n        // angular.isObject(data) ? angular.extend(this, data) : null;\r\n        if (data) {\r\n            this.id = data.activity.id;\r\n            this.name = data.activity.name;\r\n            this.budgetHours = data.activity.budgetHours;\r\n            this.useBudget = data.project.type !== 2 && data.project.type !== 4;\r\n            this.customer = data.customer;\r\n            this.department = data.department;\r\n            this.manager = data.manager;\r\n            this.project = data.project;\r\n            this.resource = data.resource;\r\n            this.color = colors[this.id % (colors.length || 1)];\r\n        }\r\n        // this.items = new Hash().fill(data.items);\r\n        this.lastTaskId = null;\r\n        this.update();\r\n    }\r\n    GanttRow.prototype = {\r\n        canSelect: function() {\r\n            return this.type === ganttGroups.ACTIVITY && this.budgetHours > 0;\r\n        },\r\n        canEdit: function() {\r\n            return this.canSelect() && this.resource.name.toLowerCase().indexOf('nondefinito') === -1;\r\n        },\r\n        mergeSlot: function(slot) {\r\n            var slots = this.slots;\r\n            slot.hours ? slots.add(slot) : slots.remove(slot);\r\n        },\r\n        insertSlot: function(key, hours, taskId) {\r\n            var slot = null;\r\n            this.useBudget ? hours = Math.min(hours, this.budgetHours - this.assignedHours) : null;\r\n            hours = Math.max(0, hours);\r\n            if (hours > 0) {\r\n                var item = {\r\n                    id: 'temp-' + (uid++),\r\n                    key: key,\r\n                    date: new Date(key * oneday),\r\n                    hours: hours,\r\n                    activityId: this.id,\r\n                };\r\n                if (taskId) {\r\n                    item.taskId = taskId;\r\n                    this.lastTaskId = taskId;\r\n                }\r\n                this.slots.add(item);\r\n                slot = this.slots.getId(item.id);\r\n            }\r\n            this.update();\r\n            return slot;\r\n        },\r\n        removeSlots: function(key) {\r\n            var day = this.days.getId(key);\r\n            day.tasks.each(function(item) {\r\n                item.hours = 0;\r\n            });\r\n            var slots = day.tasks.slice();\r\n            this.slots.removeMany(slots);\r\n            this.update();\r\n            return slots;\r\n        },\r\n        toggleSlots: function(key, hours) {\r\n            if (this.days.has(key)) {\r\n                return this.removeSlots(key);\r\n            } else {\r\n                var slot = this.insertSlot(key, hours, this.lastTaskId);\r\n                return [slot];\r\n            }\r\n        },\r\n        // WRITE CANCEL DAY SLOT\r\n        assign: function(col, value) {\r\n            console.log('assign');\r\n            var slots = this.slots,\r\n                key = col.$key;\r\n            var item = {\r\n                // errore\r\n                id: 'temp-' + (uid++),\r\n                key: key,\r\n                date: col.$date,\r\n                hours: value || 0,\r\n                activityId: this.id,\r\n            };\r\n            value ? slots.add(item) : slots.remove(item);\r\n            this.update();\r\n            return this.days.getId(key);\r\n        },\r\n        write: function(col, value, max) {\r\n            value = Math.min(value, max);\r\n            this.useBudget ? value = Math.min(value, this.budgetHours - this.assignedHours) : null;\r\n            value = Math.max(0, value);\r\n            if (value && !this.days.has(col.$key) && col.$date >= today) {\r\n                return this.assign(col, value);\r\n            }\r\n        },\r\n        erase: function(col, value, max) {\r\n            if (this.days.has(col.$key) && col.$date >= today) {\r\n                return this.assign(col, null);\r\n            }\r\n        },\r\n        toggle: function(col, value, max) {\r\n            if (this.days.has(col.$key)) {\r\n                return this.erase(col, value, max);\r\n            } else {\r\n                return this.write(col, value, max);\r\n            }\r\n        },\r\n        // WRITE CANCEL DAY SLOT\r\n        update: function() {\r\n            var total = 0;\r\n            var slots = this.slots,\r\n                days = this.days;\r\n            days.removeAll();\r\n            var taskId = null;\r\n            slots.each(function(item) {\r\n                taskId = item.taskId || taskId;\r\n                total += item ? item.hours : 0;\r\n                var day = days.add({\r\n                    key: item.key,\r\n                    date: item.date,\r\n                    hours: 0,\r\n                });\r\n                day.tasks = day.tasks || new Hash('id'); // 'taskId'\r\n                day.tasks.add(angular.copy(item));\r\n                day.tasks.each(function(task) {\r\n                    day.hours += task.hours;\r\n                });\r\n            });\r\n            this.lastTaskId = taskId || this.lastTaskId;\r\n            days.forward(); // sort by key       \r\n            this.assignedHours = total;\r\n            this.updateRanges();\r\n        },\r\n        updateMonths: function() {\r\n            var days = this.days,\r\n                months = this.months;\r\n            months.removeAll();\r\n            var previous;\r\n            days.each(function(item) {\r\n                var month = Calendar.getMonth(item);\r\n                if (month !== previous) {\r\n                    previous = month;\r\n                    Calendar.clearMonth(month);\r\n                }\r\n                months.add(month);\r\n                var day = month.days.getId(item.key);\r\n                if (day) {\r\n                    day.hours = item.hours;\r\n                    day.tasks = item.tasks;\r\n                }\r\n            });\r\n            months.forward(); // sort by key  \r\n        },\r\n        updateRanges: function() {\r\n            var days = this.days,\r\n                ranges = this.ranges;\r\n            ranges.removeAll();\r\n            var rKey = 0,\r\n                lastDay;\r\n            days.each(function(day, i) {\r\n                if (lastDay) {\r\n                    if (day.key - lastDay.key > 1 || day.tasks.differs(lastDay.tasks)) {\r\n                        rKey++;\r\n                    }\r\n                }\r\n                lastDay = day;\r\n                var range = ranges.add({\r\n                    rKey: rKey,\r\n                });\r\n                range.days = range.days || [];\r\n                range.days.push(day.key);\r\n            });\r\n            ranges.forward(); // sort by key   \r\n        },\r\n        getRange: function(col, from, to) {\r\n            var ranges = this.ranges,\r\n                range = null,\r\n                key = col.$key;\r\n            ranges.each(function(item) {\r\n                var index = item.days.indexOf(key);\r\n                if (index !== -1) {\r\n                    item.c = index;\r\n                    item.firstKey = Math.max(from, item.days[0]);\r\n                    item.lastKey = Math.min(to, item.days[item.days.length - 1]);\r\n                    range = item;\r\n                }\r\n            });\r\n            return range;\r\n        },\r\n        updateRange: function(col, from, to) {\r\n            var ranges = this.ranges,\r\n                range = this.getRange(col, from, to);\r\n            if (range) {\r\n                range.previousKey = null;\r\n                range.nextKey = null;\r\n                var r = range.rKey;\r\n                if (r > 0) {\r\n                    var p = ranges[r - 1];\r\n                    range.previousKey = p.days[p.days.length - 1];\r\n                }\r\n                if (r < ranges.length - 1) {\r\n                    var n = ranges[r + 1];\r\n                    range.nextKey = n.days[0];\r\n                }\r\n            }\r\n            return range;\r\n        },\r\n        canMoveRange: function(range, dir) {\r\n            // rifare !!!\r\n            var can = true;\r\n            var row = this;\r\n            var first = range.items[0];\r\n            var last = range.items[range.items.length - 1];\r\n            var key = row.getOffsetKey(first.startDate, dir);\r\n            var i = 0,\r\n                t = range.items.length;\r\n            while (i < t) {\r\n                var k = key + i;\r\n                if (k < todayKey || (row.days.getId(k) && range.items.indexOf(row.days.getId(k)) === -1)) { // sistemare!!\r\n                    can = false;\r\n                    i = t;\r\n                }\r\n                i++;\r\n            }\r\n            return can;\r\n        },\r\n        moveRange: function(range, dir) {\r\n            if (range.items.length) {\r\n                var row = this;\r\n                if (row.canMoveRange(range, dir)) {\r\n                    angular.forEach(range.items, function(item) {\r\n                        row.addDays(item, dir);\r\n                    });\r\n                    row.update();\r\n                }\r\n            }\r\n        },\r\n        addDays: function(item, days) {\r\n            // console.log('GanttRow.addDay', item, days);\r\n            var date = new Date(item.startDate);\r\n            date.setDate(date.getDate() + days);\r\n            item.date = date;\r\n            item.key = Math.ceil(date.getTime() / oneday);\r\n            return item;\r\n        },\r\n        getOffsetKey: function(date, day) {\r\n            var date = new Date(date);\r\n            date.setDate(date.getDate() + day);\r\n            var key = Math.ceil(date.getTime() / oneday);\r\n            return key;\r\n        },\r\n        getHours: function(key) {\r\n            var hours = 0;\r\n            var day = this.days.getId(key);\r\n            if (day) {\r\n                day.tasks.each(function(task) {\r\n                    hours += task.hours;\r\n                });\r\n            }\r\n            return hours;\r\n        },\r\n        toggleOpened: function() {\r\n            // console.log('toggleOpened');\r\n            this.opened = !this.opened;\r\n        },\r\n        compress: function(key) {\r\n            if (!this.items.length) {\r\n                return;\r\n            }\r\n            this.items.sort(function(a, b) {\r\n                return a.key - b.key;\r\n            });\r\n            var item = Utils.where(this.items, { key: key });\r\n            item = item || this.items[0];\r\n            var index = this.items.indexOf(item);\r\n            var i = index,\r\n                t = this.items.length;\r\n            key = Math.max(key, todayKey);\r\n            // da rifare\r\n            // collezionare ore totali\r\n            // redistribuire records in base a carico giornaliero\r\n            // spostare su gantt\r\n            while (i < t) {\r\n                var item = this.items[i];\r\n                item.key = key + i - index;\r\n                item.date = new Date(item.key * oneday);\r\n                i++;\r\n            }\r\n            this.update();\r\n        },\r\n    }\r\n    GanttRow.serialNumber = function(number, max) {\r\n        return new Array((1 + (max.toString().length) - (number.toString().length))).join('0');\r\n    };\r\n    return GanttRow;\r\n}]);\n/* global angular, app */\r\n\r\n\r\napp.directive('controlRow', ['$http', '$templateCache', '$compile', function($http, $templateCache, $compile) {\r\n    var aid = 0;\r\n\r\n    function _format(string, prepend, expression) {\r\n        string = string || '';\r\n        prepend = prepend || '';\r\n        var splitted = string.split(',');\r\n        if (splitted.length > 1) {\r\n            var formatted = splitted.shift();\r\n            angular.forEach(splitted, function(value, index) {\r\n                if (expression) {\r\n                    formatted = formatted.split('{' + index + '}').join('\\' + ' + prepend + value + ' + \\'');\r\n                } else {\r\n                    formatted = formatted.split('{' + index + '}').join(prepend + value);\r\n                }\r\n            });\r\n            if (expression) {\r\n                return '\\'' + formatted + '\\'';\r\n            } else {\r\n                return formatted;\r\n            }\r\n        } else {\r\n            return prepend + string;\r\n        }\r\n    }\r\n\r\n    function templateFunction(element, attributes) {\r\n        var form = attributes.form || 'Form';\r\n        var title = attributes.title || 'Untitled';\r\n        var placeholder = attributes.placeholder || title;\r\n        var name = title.replace(/[^0-9a-zA-Z]/g, \"\").split(' ').join('') + (++aid);\r\n        var formKey = form + '.' + name;\r\n        var formFocus = ' ng-focus=\"' + formKey + '.hasFocus=true\" ng-blur=\"' + formKey + '.hasFocus=false\"';\r\n        var message = '',\r\n            decoration = '',\r\n            disabled = '';\r\n        var label = (attributes.label ? attributes.label : 'name');\r\n        var key = (attributes.key ? attributes.key : 'id');\r\n        var model = attributes.model;\r\n        var change = (attributes.onChange ? ' ng-change=\"' + attributes.onChange + '\"' : '');\r\n        var focus = (attributes.onFocus ? ' ng-focus=\"' + attributes.onFocus + '\"' : '');\r\n        var blur = (attributes.onBlur ? ' ng-blur=\"' + attributes.onBlur + '\"' : '');\r\n        var inputCols = attributes.cols ? 6 : 9;\r\n        var colInput = 'col-lg-' + inputCols;\r\n        var colLabel = 'col-lg-' + (12 - inputCols);\r\n        if (attributes.cols === '12') {\r\n            colLabel = colInput = 'col-lg-12';\r\n        }\r\n        var required = (attributes.required ? ' required=\"true\"' : '');\r\n        var readonly = (attributes.readonly ? ' readonly' : '');\r\n        var options = (attributes.options ? ' ng-model-options=\"' + attributes.options + '\" ' : '');\r\n        var validate = (attributes.validate ? ' validate-type=\"' + attributes.validate + '\" ' : '');\r\n        var format = (attributes.format ? ' format=\"' + attributes.format + '\" ' : '');\r\n        var precision = (attributes.precision ? ' precision=\"' + attributes.precision + '\" ' : '');\r\n        if (attributes.disabled) {\r\n            disabled = ' disabled';\r\n        }\r\n        if (attributes.ngDisabled) {\r\n            disabled = ' ng-disabled=\"' + attributes.ngDisabled + '\"';\r\n        }\r\n        if (attributes.required) {\r\n            decoration = attributes.readonly || attributes.disabled ? '' : '<sup>âœ½</sup>';\r\n        }\r\n        message = '<span ng-messages=\"' + (attributes.readonly ? '' : '(' + form + '.$submitted || ' + formKey + '.$touched) && ') + formKey + '.$error\" role=\"alert\">';\r\n        message = message + '<span ng-message=\"required\" class=\"label-error animated flash\">obbligatorio â¤´</span>';\r\n        switch (attributes.controlRow) {\r\n            case 'password':\r\n                message = message + '<span ng-message=\"minlength\" class=\"label-error animated flash\">almeno 6 caratteri â¤´</span>';\r\n                break;\r\n            case 'email':\r\n                message = message + '<span ng-message=\"email\" class=\"label-error animated flash\">valore non corretto â¤´</span>';\r\n                break;\r\n            case 'number':\r\n            case 'range':\r\n                message = message + '<span ng-message=\"positive\" class=\"label-error animated flash\">solo valori positivi â¤´</span>';\r\n                message = message + '<span ng-message=\"number\" class=\"label-error animated flash\">solo valori numerici â¤´</span>';\r\n                break;\r\n        }\r\n        if (attributes.match !== undefined) {\r\n            message = message + '<span ng-message=\"match\" class=\"label-error animated flash\">non corrispondente â¤´</span>';\r\n        }\r\n        message = message + '</span>';\r\n        var validation = ' ng-class=\"{ \\'control-focus\\': ' + formKey + '.hasFocus, \\'control-success\\': ' + formKey + '.$valid, \\'control-error\\': ' + formKey + '.$invalid && (' + form + '.$submitted || ' + formKey + '.$touched), \\'control-empty\\': !' + formKey + '.$viewValue }\"';\r\n        var template = '<div class=\"row\" ' + validation + '><label for=\"' + name + '\" class=\"' + colLabel + ' col-form-label\">' + title + decoration + '</label><div class=\"' + colInput + ' col-' + attributes.controlRow + '\">';\r\n        switch (attributes.controlRow) {\r\n            case 'static':\r\n                var click = (attributes.click ? ' ng-click=\"' + attributes.click + '\"' : '');\r\n                var mouseover = (attributes.mouseover ? ' ng-mouseover=\"' + attributes.mouseover + '\"' : '');\r\n                var mouseout = (attributes.mouseout ? ' ng-mouseover=\"' + attributes.mouseout + '\"' : '');\r\n                var icon = (attributes.icon ? '<i class=\"pull-xs-right ' + attributes.icon + '\"></i>' : '');\r\n                template += '<p class=\"form-control\" ' + click + mouseover + mouseout + '><span ng-bind-html=\"' + model + ' || \\'&nbsp;\\'\"></span>' + icon + '</p>';\r\n                break;\r\n            case 'checkbox':\r\n                template = '<div class=\"' + colInput + '\"' + validation + '><div class=\"col-xs-12\"><label class=\"custom-control custom-checkbox\">';\r\n                template += '   <input type=\"checkbox\" class=\"custom-control-input\" ng-model=\"' + model + '\">';\r\n                template += '   <span class=\"custom-control-indicator\"></span>';\r\n                template += '   <span class=\"custom-control-description\">' + title + '</span>';\r\n                template += '</label>';\r\n                // template += '<input id=\"' + name + '\" name=\"' + name + '\" type=\"checkbox\" ng-model=\"' + model + '\" ' + change + focus + blur + required + ' class=\"toggle toggle-round-flat\">';\r\n                /*\r\n                template = '<div class=\"checkbox\">';\r\n                template += '<span class=\"checkbox-label\">' + title + required +'</span>';\r\n                template += '<span class=\"switch\"><input id=\"' + name + '\" name=\"' + name + '\" type=\"checkbox\" ng-model=\"' + model + '\" ' + change + focus + blur + required + ' class=\"toggle toggle-round-flat\"><label for=\"' + name + '\"></label></span>';\r\n                template += '</div>';\r\n                */\r\n                break;\r\n            case 'yesno':\r\n                template = '<div class=\"row\" ' + validation + '><label class=\"col-lg-6 custom-control custom-checkbox\">' + title + decoration + '</label>';\r\n                template += '<div class=\"' + colLabel + '\"><label class=\"custom-control custom-checkbox\">';\r\n                template += '   <input type=\"checkbox\" class=\"custom-control-input\" ng-model=\"' + model + '\" ng-change=\"' + model + 'No=!' + model + '\">';\r\n                template += '   <span class=\"custom-control-indicator\"></span>';\r\n                template += '   <span class=\"custom-control-description\">SÃ¬</span>';\r\n                template += '</label></div>';\r\n                template += '<div class=\"' + colLabel + '\"><label class=\"custom-control custom-checkbox\">';\r\n                template += '   <input type=\"checkbox\" class=\"custom-control-input\" ng-model=\"' + model + 'No\" ng-change=\"' + model + '=!' + model + 'No\">';\r\n                template += '   <span class=\"custom-control-indicator\"></span>';\r\n                template += '   <span class=\"custom-control-description\">No</span>';\r\n                template += '</label>';\r\n                // template += '<input id=\"' + name + '\" name=\"' + name + '\" type=\"checkbox\" ng-model=\"' + model + '\" ' + change + focus + blur + required + ' class=\"toggle toggle-round-flat\">';\r\n                /*\r\n                template = '<div class=\"checkbox\">';\r\n                template += '<span class=\"checkbox-label\">' + title + required +'</span>';\r\n                template += '<span class=\"switch\"><input id=\"' + name + '\" name=\"' + name + '\" type=\"checkbox\" ng-model=\"' + model + '\" ' + change + focus + blur + required + ' class=\"toggle toggle-round-flat\"><label for=\"' + name + '\"></label></span>';\r\n                template += '</div>';\r\n                */\r\n                break;\r\n            case 'switch':\r\n                if (attributes.disabled) {\r\n                    disabled = ' disabled=\"true\"';\r\n                }\r\n                if (attributes.ngDisabled) {\r\n                    disabled = ' disabled=\"' + attributes.ngDisabled + '\"';\r\n                }\r\n                template = '<div class=\"row control-switch\" ' + validation + '><label for=\"' + name + '\" class=\"' + colLabel + ' col-form-label\">' + title + decoration + '</label>';\r\n                template += '<div class=\"' + colInput + '\">';\r\n                template += '<switch name=\"' + name + '\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' on=\"SÃ¬\" off=\"No\" ' + required + disabled + readonly + formFocus + '></switch>';\r\n                break;\r\n            case 'range':\r\n                validate = ' validate-type=\"number\"';\r\n                var nameHi = name + 'Hi';\r\n                var formKeyHi = form + '.' + nameHi;\r\n                var modelHi = attributes.modelHi;\r\n                var validationHi = ' ng-class=\"{ \\'control-focus\\': ' + formKeyHi + '.hasFocus, \\'control-success\\': ' + formKeyHi + '.$valid, \\'control-error\\': ' + formKeyHi + '.$invalid && (' + form + '.$submitted || ' + formKeyHi + '.$touched), \\'control-empty\\': !' + formKeyHi + '.$viewValue }\"';\r\n                var requiredHi = required;\r\n                if (attributes.requiredHi == 'true') {\r\n                    requiredHi = ' required=\"true\"';\r\n                } else if (attributes.requiredHi == 'false') {\r\n                    requiredHi = '';\r\n                }\r\n                var messageHi = ' ',\r\n                    decorationHi = ' ';\r\n                if (attributes.required && attributes.requiredHi !== 'false') {\r\n                    decorationHi = attributes.readonly || attributes.disabled ? '' : '<sup>âœ½</sup>';\r\n                }\r\n                messageHi = '<span ng-messages=\"' + (attributes.readonly ? '' : '(' + form + '.$submitted || ' + formKeyHi + '.$touched) && ') + formKeyHi + '.$error\" role=\"alert\">';\r\n                messageHi = messageHi + '<span ng-message=\"required\" class=\"label-error animated flash\">obbligatorio â¤´</span>';\r\n                switch (attributes.controlRow) {\r\n                    case 'password':\r\n                        messageHi = messageHi + '<span ng-message=\"minlength\" class=\"label-error animated flash\">almeno 3 caratteri â¤´</span>';\r\n                        break;\r\n                    case 'email':\r\n                        messageHi = messageHi + '<span ng-message=\"email\" class=\"label-error animated flash\">valore non corretto â¤´</span>';\r\n                        break;\r\n                    case 'number':\r\n                    case 'range':\r\n                        messageHi = messageHi + '<span ng-message=\"positive\" class=\"label-error animated flash\">solo valori positivi â¤´</span>';\r\n                        messageHi = messageHi + '<span ng-message=\"number\" class=\"label-error animated flash\">solo valori numerici â¤´</span>';\r\n                        break;\r\n                }\r\n                if (attributes.match !== undefined) {\r\n                    messageHi = messageHi + '<span ng-message=\"match\" class=\"label-error animated flash\">non corrispondente â¤´</span>';\r\n                }\r\n                messageHi = messageHi + '</span>';\r\n                template = '<div class=\"row\"><label for=\"' + name + '\" class=\"' + colLabel + ' col-form-label\">' + title + '</label><div class=\"' + colInput + ' col-' + attributes.controlRow + '\">';\r\n                template += '<div class=\"form-control-range form-control-range-min\" ' + validation + '>' + decoration + '<input class=\"form-control\" name=\"' + name + '\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + required + disabled + readonly + formFocus + validate + format + precision + '>' + message + '</div>';\r\n                template += '<div class=\"form-control-range form-control-range-max\" ' + validationHi + '>' + decorationHi + '<input class=\"form-control\" name=\"' + nameHi + '\" ng-model=\"' + modelHi + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + requiredHi + disabled + readonly + formFocus + validate + format + precision + '>' + messageHi + '</div>';\r\n                return template + '</div></div>';\r\n                break;\r\n            case 'range-slider':\r\n                var himodel = (attributes.himodel ? ' rz-slider-high=\"' + attributes.himodel + '\" ' : '');\r\n                options = (attributes.options ? ' rz-slider-options=\"' + attributes.options + '\" ' : '');\r\n                template += '<rzslider rz-slider-model=\"' + model + '\" ' + himodel + options + '\"></rzslider>';\r\n                break;\r\n            case 'select':\r\n                var filter = (attributes.min ? ' | filter:gte(\\'' + key + '\\', ' + attributes.min + ')' : '');\r\n                var optionLabel = _format(label, 'item.', true);\r\n                var options = attributes.number ?\r\n                    'item.' + key + ' as ' + optionLabel + ' disable when item.disabled for item in ' + attributes.source + filter :\r\n                    optionLabel + ' disable when item.disabled for item in ' + attributes.source + filter + ' track by item.' + key;\r\n                template += '<select name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + ' ng-options=\"' + options + '\" ' + (attributes.number ? 'convert-to-number' : '') + required + disabled + '><option value=\"\" disabled selected hidden>' + placeholder + '</option></select>';\r\n                break;\r\n            case 'autocomplete':\r\n                var canCreate = (attributes.canCreate ? attributes.canCreate : false);\r\n                var flatten = (attributes.flatten ? attributes.flatten : false);\r\n                var queryable = (attributes.queryable ? attributes.queryable : false);\r\n                var onSelected = (attributes.onSelected ? ' on-selected=\"' + attributes.onSelected + '\"' : '');\r\n                template += '<input name=\"' + name + '\" ng-model=\"' + model + '\" type=\"hidden\" ' + (attributes.required ? 'required' : '') + '>';\r\n                template += '<div control-autocomplete=\"' + attributes.source + '\" model=\"' + model + '\" label=\"' + label + '\"  key=\"' + key + '\" can-create=\"' + canCreate + '\" flatten=\"' + flatten + '\" queryable=\"' + queryable + '\" placeholder=\"' + placeholder + '\" on-focus=\"' + formKey + '.hasFocus=true\" on-blur=\"' + formKey + '.hasFocus=false\"' + onSelected + '></div>';\r\n                break;\r\n            case 'textarea':\r\n                var rows = (attributes.rows ? attributes.rows : '1');\r\n                template += '<textarea name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" ' + required + disabled + ' rows=\"' + rows + '\"' + formFocus + '></textarea>';\r\n                break;\r\n            case 'htmltext':\r\n                var taDisabled = '';\r\n                if (attributes.disabled) {\r\n                    taDisabled = ' ta-disabled=\"true\"';\r\n                }\r\n                if (attributes.ngDisabled) {\r\n                    taDisabled = ' ta-disabled=\"' + attributes.ngDisabled + '\"';\r\n                }\r\n                template += '<div text-angular name=\"' + name + '\" ta-paste=\"doStripHtml($html)\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" ' + required + taDisabled + readonly + formFocus + (attributes.required ? ' ta-min-text=\"1\"' : '') + '></div>';\r\n                break;\r\n            case 'password':\r\n                template += '<div class=\"input-group\"><input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"{{form.' + name + ' ? \\'password\\' : \\'text\\'}}\" ng-minlength=\"6\" ' + required + disabled + formFocus + '><span class=\"input-group-addon\" ng-if=\"' + model + '\"><span class=\"icon-eye\" ng-click=\"form.' + name + ' = !form.' + name + '\"></span></span></div>';\r\n                break;\r\n            case 'email':\r\n                template += '<input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"email\" ' + required + disabled + formFocus + '>';\r\n                break;\r\n            case 'number-picker':\r\n                validate = ' validate-type=\"anynumber\"';\r\n                /*\r\n                var doSub = model + ' = ' + model + ' -1';\r\n                if (attributes.min) {\r\n                    validate += ' min=\"' + attributes.min + '\"';\r\n                    doSub = model + ' = Math.max(' + attributes.min + ', ' + model + ' -1)';\r\n                }\r\n                var doAdd = model + ' = ' + model + ' +1';\r\n                if (attributes.max) {\r\n                    validate += ' max=\"' + attributes.max + '\"';\r\n                    doAdd = model + ' = Math.min(' + attributes.max + ', ' + model + ' +1)';\r\n                }\r\n                template += '<div class=\"input-group\">';\r\n                template += '   <span class=\"input-group-btn\"><button class=\"btn btn-outline-primary\" type=\"button\" ng-click=\"(' + doSub + ')\">-</button></span>';\r\n                template += '   <input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + required + disabled + readonly + formFocus + validate + format + precision + '>';\r\n                template += '   <span class=\"input-group-btn\"><button class=\"btn btn-outline-primary\" type=\"button\" ng-click=\"(' + doAdd + ')\">+</button></span>';\r\n                template += '</div>';\r\n                */\r\n                template += '<div number-picker=\"' + model + '\" min=\"' + attributes.min + '\" max=\"' + attributes.max + '\">';\r\n                template += '   <input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + required + disabled + readonly + formFocus + validate + format + precision + '>';\r\n                template += '</div>';\r\n                break;\r\n            case 'number':\r\n                validate = ' validate-type=\"number\"';\r\n                template += '<input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + required + disabled + readonly + formFocus + validate + format + precision + '>';\r\n                break;\r\n            case 'anynumber':\r\n                validate = ' validate-type=\"anynumber\"';\r\n                template += '<input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + required + disabled + readonly + formFocus + validate + format + precision + '>';\r\n                break;\r\n            case 'date':\r\n                validate = ' validate-type=\"date\"';\r\n                format = ' format=\"dd-MM-yyyy\"';\r\n                if (attributes.disabled || attributes.readonly) {\r\n                    template += '<div class=\"input-group\"><input type=\"text\" class=\"form-control\" name=\"' + name + '\" ng-model=\"' + model + '\" placeholder=\"' + placeholder + '\" ' + required + disabled + readonly + formFocus + validate + format + '><span class=\"input-group-addon\"><i class=\"icon-calendar\"></i></span></div>';\r\n                } else {\r\n                    template += '<input type=\"date\" name=\"' + name + '\" class=\"form-control form-control-hidden\" is-open=\"flags.' + name + '\" ng-model=\"' + model + '\" placeholder=\"dd-MM-yyyy\" ' + required + disabled + readonly + formFocus + ' uib-datepicker-popup datepicker-options=\"sources.datepickerOptions\" datepicker-template-url=\"uib/template/datepicker/datepicker.html\" show-button-bar=\"false\" current-text=\"Oggi\" clear-text=\"Rimuovi\" close-text=\"Chiudi\">';\r\n                    template += '<div ng-click=\"(flags.' + name + ' = true)\" class=\"input-group disabled\"><input type=\"text\" class=\"form-control\" name=\"' + name + '\" ng-model=\"' + model + '\" placeholder=\"' + placeholder + '\" ' + required + disabled + readonly + formFocus + validate + format + '><span class=\"input-group-addon\"><i class=\"icon-calendar\"></i></span></div>';\r\n                }\r\n                break;\r\n                /*\r\n            case 'date':\r\n                placeholder = placeholder || 'dd-MM-yyyy';\r\n                template += '<input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"date\"' + required + disabled + readonly + formFocus + '>';\r\n                break;\r\n                */\r\n            case 'datetime-local':\r\n                placeholder = placeholder || 'dd-MM-yyyyTHH:mm:ss';\r\n                // placeholder == title ? placeholder = 'dd/MM/yyyyTHH:mm:ss' : null;\r\n                template += '<input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"datetime-local\"' + required + disabled + readonly + formFocus + '>';\r\n                break;\r\n            case 'text':\r\n            default:\r\n                template += '<input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + required + disabled + readonly + formFocus + validate + format + precision + '>';\r\n                break;\r\n        }\r\n        return template + message + '</div></div>';\r\n    }\r\n    return {\r\n        restrict: 'A',\r\n        replace: true,\r\n        compile: function(templateElement, templateAttributes) {\r\n            return function(scope, element, attributes) {\r\n                element.html(templateFunction(templateElement, templateAttributes));\r\n                $compile(element.contents())(scope);\r\n            }\r\n        }\r\n    }\r\n}]);\r\n\r\napp.directive('numberPicker', ['$parse', '$timeout', function($parse, $timeout) {\r\n    return {\r\n        restrict: 'A',\r\n        template: '<div class=\"input-group\">' +\r\n            '   <span class=\"input-group-btn\"><button class=\"btn btn-outline-primary\" type=\"button\">-</button></span>' +\r\n            '   <div ng-transclude></div>' +\r\n            '   <span class=\"input-group-btn\"><button class=\"btn btn-outline-primary\" type=\"button\">+</button></span>' +\r\n            '</div>',\r\n        replace: true,\r\n        transclude: true,\r\n        link: function(scope, element, attributes, model) {\r\n            var node = element[0];\r\n            var nodeRemove = node.querySelectorAll('.input-group-btn > .btn')[0];\r\n            var nodeAdd = node.querySelectorAll('.input-group-btn > .btn')[1];\r\n\r\n            function onRemove(e) {\r\n                var min = $parse(attributes.min)(scope);\r\n                var getter = $parse(attributes.numberPicker);\r\n                var setter = getter.assign;\r\n                $timeout(function() {\r\n                    setter(scope, Math.max(min, getter(scope) - 1));\r\n                });\r\n                // console.log('numberPicker.onRemove', min);\r\n            }\r\n\r\n            function onAdd(e) {\r\n                var max = $parse(attributes.max)(scope);\r\n                var getter = $parse(attributes.numberPicker);\r\n                var setter = getter.assign;\r\n                $timeout(function() {\r\n                    setter(scope, Math.min(max, getter(scope) + 1));\r\n                });\r\n                // console.log('numberPicker.onAdd', max);\r\n            }\r\n\r\n            function addListeners() {\r\n                angular.element(nodeRemove).on('touchstart mousedown', onRemove);\r\n                angular.element(nodeAdd).on('touchstart mousedown', onAdd);\r\n            }\r\n\r\n            function removeListeners() {\r\n                angular.element(nodeRemove).off('touchstart mousedown', onRemove);\r\n                angular.element(nodeAdd).off('touchstart mousedown', onAdd);\r\n            }\r\n            scope.$on('$destroy', function() {\r\n                removeListeners();\r\n            });\r\n            addListeners();\r\n        }\r\n    }\r\n}]);\r\n\r\n\r\n\r\napp.directive('validateType', ['$filter', function($filter) {\r\n    return {\r\n        require: 'ngModel',\r\n        link: function(scope, element, attributes, model) {\r\n            var validateType = attributes.validateType;\r\n            var format = attributes.format || '';\r\n            var precision = attributes.precision || 2;\r\n            var focus = false;\r\n            switch (validateType) {\r\n                case 'date':\r\n                case 'datetime':\r\n                case 'datetime-local':\r\n                    model.$formatters.push(function(value) {\r\n                        if (value) {\r\n                            return $filter('date')(value, format);\r\n                        } else {\r\n                            return null;\r\n                        }\r\n                    });\r\n                    break;\r\n                case 'number':\r\n                    model.$parsers.unshift(function(value) {\r\n                        var valid = false,\r\n                            type = validateType;\r\n                        if (value !== undefined && value !== \"\") {\r\n                            valid = String(value).indexOf(Number(value).toString()) !== -1; // isFinite(value); // \r\n                            value = Number(value);\r\n                            model.$setValidity('number', valid);\r\n                            if (valid) {\r\n                                model.$setValidity('positive', value >= 0.01);\r\n                                attributes.min !== undefined ? model.$setValidity('range', value >= Number(attributes.min)) : null;\r\n                                attributes.max !== undefined ? model.$setValidity('range', value <= Number(attributes.max)) : null;\r\n                            }\r\n                            /*                             \r\n                            if (valid) {\r\n                                if (value < 0.01) {\r\n                                    valid = false;\r\n                                    type = 'positive';\r\n                                }\r\n                                if (valid && attributes.min !== undefined) {\r\n                                    valid = valid && value >= Number(attributes.min);\r\n                                    if (!valid) {\r\n                                        type = 'range';\r\n                                    }\r\n                                }\r\n                                if (valid && attributes.max !== undefined) {\r\n                                    valid = valid && value <= Number(attributes.max);\r\n                                    if (!valid) {\r\n                                        type = 'range';\r\n                                    }\r\n                                }\r\n                            }\r\n                            */\r\n                            // console.log('validateType.number', type, valid, value);\r\n                        } else {\r\n                            valid = true;\r\n                            value = Number(value);\r\n                            model.$setValidity('number', true);\r\n                            model.$setValidity('positive', true);\r\n                            attributes.min !== undefined ? model.$setValidity('range', true) : null;\r\n                            attributes.max !== undefined ? model.$setValidity('range', true) : null;\r\n                        }\r\n                        return value;\r\n                    });\r\n                    model.$formatters.push(function(value) {\r\n                        if (value) {\r\n                            return $filter('number')(value, precision) + ' ' + format;\r\n                        } else {\r\n                            return null;\r\n                        }\r\n                    });\r\n                    /*\r\n                    model.$render = function () {\r\n                        console.log('model.render', model.$modelValue);\r\n                        element[0].value = model.$modelValue ? $filter('number')(model.$modelValue, precision) + ' ' + format : ' ';\r\n                    };\r\n                    */\r\n                    break;\r\n                case 'anynumber':\r\n                    model.$parsers.unshift(function(value) {\r\n                        var valid = false,\r\n                            type = validateType;\r\n                        if (value !== undefined && value !== \"\") {\r\n                            valid = String(value).indexOf(Number(value).toString()) !== -1; // isFinite(value); // \r\n                            value = Number(value);\r\n                            model.$setValidity('number', valid);\r\n                            if (valid) {\r\n                                attributes.min !== undefined ? model.$setValidity('range', value >= Number(attributes.min)) : null;\r\n                                attributes.max !== undefined ? model.$setValidity('range', value <= Number(attributes.max)) : null;\r\n                            }\r\n                        } else {\r\n                            valid = true;\r\n                            value = Number(value);\r\n                            model.$setValidity('number', true);\r\n                            attributes.min !== undefined ? model.$setValidity('range', true) : null;\r\n                            attributes.max !== undefined ? model.$setValidity('range', true) : null;\r\n                        }\r\n                        return value;\r\n                    });\r\n                    model.$formatters.push(function(value) {\r\n                        if (value || value === 0) {\r\n                            return $filter('number')(value, precision) + ' ' + format;\r\n                        } else {\r\n                            return null;\r\n                        }\r\n                    });\r\n                    break;\r\n            }\r\n\r\n            function onFocus() {\r\n                focus = true;\r\n                if (format) {\r\n                    element[0].value = model.$modelValue || null;\r\n                    if (!model.$modelValue) {\r\n                        model.$setViewValue(null);\r\n                    }\r\n                }\r\n            }\r\n\r\n            function doBlur() {\r\n                if (format && !model.$invalid) {\r\n                    switch (validateType) {\r\n                        case 'date':\r\n                        case 'datetime':\r\n                        case 'datetime-local':\r\n                            element[0].value = model.$modelValue ? $filter('date')(model.$modelValue, format) : ' ';\r\n                            break;\r\n                        default:\r\n                            element[0].value = model.$modelValue ? $filter('number')(model.$modelValue, precision) + ' ' + format : ' ';\r\n                            break;\r\n                    }\r\n                }\r\n            }\r\n\r\n            function onBlur() {\r\n                focus = false;\r\n                doBlur();\r\n            }\r\n\r\n            function addListeners() {\r\n                element.on('focus', onFocus);\r\n                element.on('blur', onBlur);\r\n            }\r\n\r\n            function removeListeners() {\r\n                element.off('focus', onFocus);\r\n                element.off('blur', onBlur);\r\n            }\r\n            scope.$on('$destroy', function() {\r\n                removeListeners();\r\n            });\r\n            addListeners();\r\n        }\r\n    };\r\n}]);\n/* global angular, app, Autolinker */\r\n\n/* global angular, app */\r\n\r\napp.factory('State', ['$timeout', function($timeout) {\r\n    function State() {\r\n        this.isReady = false;\r\n        this.idle();\r\n    }\r\n    State.prototype = {\r\n        idle: function() {\r\n            this.isBusy = false;\r\n            this.isError = false;\r\n            this.isErroring = false;\r\n            this.isSuccess = false;\r\n            this.isSuccessing = false;\r\n            this.button = null;\r\n            this.errors = [];\r\n        },\r\n        enabled: function() {\r\n            return !this.isBusy && !this.isErroring && !this.isSuccessing;\r\n        },\r\n        busy: function() {\r\n            if (!this.isBusy) {\r\n                this.isBusy = true;\r\n                this.isError = false;\r\n                this.isErroring = false;\r\n                this.isSuccess = false;\r\n                this.isSuccessing = false;\r\n                this.errors = [];\r\n                // console.log('State.busy', this);\r\n                return true;\r\n            } else {\r\n                return false;\r\n            }\r\n        },\r\n        success: function() {\r\n            this.isBusy = false;\r\n            this.isError = false;\r\n            this.isErroring = false;\r\n            this.isSuccess = true;\r\n            this.isSuccessing = true;\r\n            this.errors = [];\r\n            $timeout(function() {\r\n                this.isSuccessing = false;\r\n                this.button = null;\r\n            }.bind(this), 1000);\r\n        },\r\n        error: function(error) {\r\n            this.isBusy = false;\r\n            this.isError = true;\r\n            this.isErroring = true;\r\n            this.isSuccess = false;\r\n            this.isSuccessing = false;\r\n            this.errors.push(error);\r\n            $timeout(function() {\r\n                this.isErroring = false;\r\n                this.button = null;\r\n            }.bind(this), 1000);\r\n        },\r\n        ready: function() {\r\n            this.isReady = true;\r\n            this.success();\r\n        },\r\n        errorMessage: function() {\r\n            return this.isError ? this.errors[this.errors.length - 1] : null;\r\n        },\r\n        submitClass: function() {\r\n            return {\r\n                busy: this.isBusy,\r\n                ready: this.isReady,\r\n                successing: this.isSuccessing,\r\n                success: this.isSuccess,\r\n                errorring: this.isErroring,\r\n                error: this.isError,\r\n            };\r\n        },\r\n        submitMessage: function(idleMessage, busyMessage, successMessage, errorMessage) {\r\n            idleMessage = idleMessage || 'Submit';\r\n            if (this.isBusy) {\r\n                return busyMessage || idleMessage;\r\n            } else if (this.isSuccess) {\r\n                return successMessage || idleMessage;\r\n            } else if (this.isError) {\r\n                return errorMessage || idleMessage;\r\n            } else {\r\n                return idleMessage;\r\n            }\r\n        },\r\n    };\r\n    return State;\r\n}]);\r\n\r\napp.factory('User', ['$q', '$location', 'LocalStorage', 'Api', function($q, $location, storage, Api) {\r\n    function User(data) {\r\n        data ? angular.extend(this, data) : null;\r\n    }\r\n    User.prototype = {};\r\n    User.current = function() {\r\n        return storage.get('user');\r\n    };\r\n    User.isLoggedOrGoTo = function(redirect) {\r\n        var deferred = $q.defer();\r\n        var q = storage.get('q');\r\n\r\n        function success(response) {\r\n            storage.set('q', window.btoa(JSON.stringify({\r\n                un: response.userName,\r\n                pwd: response.password\r\n            })));\r\n            response.password = null;\r\n            storage.set('user', { id: response.id });\r\n            deferred.resolve(response);\r\n        }\r\n\r\n        function error(response) {\r\n            deferred.reject(response);\r\n            $location.$$lastRequestedPath = $location.path();\r\n            $location.path(redirect);\r\n        }\r\n        if (q) {\r\n            Api.auth.sso(q).then(success, error);\r\n        } else {\r\n            Api.auth.current().then(success, error);\r\n        }\r\n        return deferred.promise;\r\n    };\r\n    User.signin = function(model) {\r\n        var deferred = $q.defer();\r\n        Api.auth.signin(model).then(function success(response) {\r\n            storage.set('q', window.btoa(JSON.stringify({\r\n                un: response.userName,\r\n                pwd: response.password\r\n            })));\r\n            response.password = null;\r\n            storage.set('user', { id: response.id });\r\n            deferred.resolve(response);\r\n        }, function error(response) {\r\n            deferred.reject(response);\r\n        });\r\n        return deferred.promise;\r\n    };\r\n    User.signout = function() {\r\n        var deferred = $q.defer();\r\n        var user = storage.get('user');\r\n        if (user) {\r\n            Api.auth.signout(user.id).then(function success(response) {\r\n                storage.delete('q');\r\n                storage.delete('user');\r\n                deferred.resolve(response);\r\n            }, function error(response) {\r\n                deferred.reject(response);\r\n            });\r\n        } else {\r\n            deferred.reject(null);\r\n        }\r\n        return deferred.promise;\r\n    };\r\n    return User;\r\n}]);\n/* global angular, app */\n\napp.service('Api', ['$http', '$q', '$timeout', '$location', 'FirebaseService', function($http, $q, $timeout, $location, FirebaseService) {\n\n    var _service = new FirebaseService({\n        onPresences: function(items) {\n            console.log('Api.onPresences', items.length);\n        },\n        onActivities: function(items) {\n            console.log('Api.onActivities', items.length);\n        }\n    });\n\n    var _this = this;\n\n    /*\n    var _get = this.get = function (url, params) {\n        var deferred = $q.defer();\n        $http.get(url, { params: params }).then(function (response) {\n            deferred.resolve(response.data);\n        }, function (response) {\n            onError(deferred, 'get', url, { params: params }, response);\n        });\n        return deferred.promise;\n    };\n    var _post = this.post = function (url, model) {\n        var deferred = $q.defer();\n        if (_this.DEBUG) {\n            console.log('Api.DEBUG', url, model);\n            deferred.resolve(model);\n        } else {\n            $http.post(url, model).then(function (response) {\n                deferred.resolve(response.data);\n            }, function (response) {\n                onError(deferred, 'post', url, model, response);\n            });\n        }\n        return deferred.promise;\n    };\n    var _put = this.put = function (url, model) {\n        var deferred = $q.defer();\n        $http.put(url, model).then(function (response) {\n            deferred.resolve(response.data);\n        }, function (response) {\n            onError(deferred, 'put', url, model, response);\n        });\n        return deferred.promise;\n    };\n    var _patch = this.patch = function (url, model) {\n        var deferred = $q.defer();\n        $http.patch(url, model).then(function (response) {\n            deferred.resolve(response.data);\n        }, function (response) {\n            onError(deferred, 'patch', url, model, response);\n        });\n        return deferred.promise;\n    };\n    var _delete = this.delete = function (url) {\n        var deferred = $q.defer();\n        $http.delete(url).then(function (response) {\n            deferred.resolve(response.data);\n        }, function (response) {\n            onError(deferred, 'delete', url, null, response);\n        });\n        return deferred.promise;\n    };\n    var _blob = this.blob = function (url, model) {\n        var deferred = $q.defer();\n        if (_this.DEBUG) {\n            console.log('Api.DEBUG', url, model);\n            deferred.resolve(model);\n        } else {\n            $http({\n                url: url,\n                method: \"POST\",\n                data: model,\n                headers: {\n                    'Content-type': 'application/json'\n                },\n                responseType: 'arraybuffer',\n            }).then(function (response) {\n                deferred.resolve(response);\n            }, function (response) {\n                onError(deferred, 'post', url, model, response);\n            });\n        }\n        return deferred.promise;\n    };\n    */\n\n    this.auth = {\n        signin: _service.signin,\n        // return _post('/api/auth/login', model);\n        signout: function(userId) {\n            // return _get('/api/auth/logout/' + userId);\n        },\n        current: function() {\n            var deferred = $q.defer();\n            if (_service.user) {\n                deferred.resolve(_service.user);\n            } else {\n                deferred.reject();\n            }\n            return deferred.promise;\n            // return _get('/api/auth/current/');\n        },\n    };\n\n}]);\n\napp.factory('FirebaseService', ['$q', '$firebaseAuth', '$firebaseObject', '$firebaseArray', function($q, $firebaseAuth, $firebaseObject, $firebaseArray) {\n    var config = null;\n\n    function getConfig() {\n        if (!config) {\n            // Initialize the Firebase SDK\n            config = {\n                apiKey: \"AIzaSyCskd8Cgzd_j7JzgEC3mEb4ir1qZFh6auQ\",\n                authDomain: \"starfish-c2b0f.firebaseapp.com\",\n                databaseURL: \"https://starfish-c2b0f.firebaseio.com\",\n                projectId: \"starfish-c2b0f\",\n                storageBucket: \"starfish-c2b0f.appspot.com\",\n                messagingSenderId: \"796739915579\"\n            };\n            firebase.initializeApp(config);\n        }\n        return config;\n    }\n\n    function FirebaseService(options) {\n        var defaults = {\n            onPresences: function(items) {\n                console.log('FirebaseService.onPresences', items.length);\n            },\n            onActivities: function(items) {\n                console.log('FirebaseService.onActivities', items.length);\n            }\n        };\n        this.options = options ? angular.extend(defaults, options) : defaults;\n        this.config = getConfig();\n    }\n    FirebaseService.prototype = {\n        signin: function($user) {\n            console.log('FirebaseService.signin', $user);\n            var deferred = $q.defer();\n            if (this.user) {\n                console.log('Signed in as', this.user);\n                deferred.resolve(this.user);\n            } else {\n                var random = 10000 + Math.floor(Math.random() * 1000);\n                var user = this.user = {\n                    id: random,\n                    name: 'Firebase ' + random,\n                    firstName: 'Firebase',\n                    lastName: random,\n                };\n                if ($user) {\n                    for (var p in user) {\n                        user[p] = $user[p] || user[p];\n                    }\n                }\n                user.timestamp = Date.now();\n                var fs = this;\n                var auth = this.auth = $firebaseAuth();\n                auth.$signInAnonymously({ remember: 'sessionOnly' }).then(function(logged) {\n                    user.uid = logged.uid;\n                    console.log('Signed in as', user);\n                    deferred.resolve(user);\n                }).catch(function(error) {\n                    console.log('Error', error);\n                    deferred.reject(error);\n                });\n            }\n            return deferred.promise;\n        },\n        getPresences: function() {\n            var deferred = $q.defer();\n            var fs = this;\n            var user = this.user;\n            var root = this.root = firebase.database().ref();\n            var presencesRef = root.child('presences');\n            var userRef = presencesRef.push();\n            var connectedRef = root.child('.info/connected');\n            connectedRef.on('value', function(snap) {\n                if (snap.val()) {\n                    userRef.onDisconnect().remove();\n                    userRef.set(user);\n                    fs.updateUser = function() {\n                        userRef.set(user);\n                    };\n                    deferred.resolve();\n                }\n            });\n            presencesRef.on('value', function(snap) {\n                // console.log('# of online users = ', snap.numChildren());\n                var presences = snap.val(),\n                    items = [];\n                for (var key in presences) {\n                    var user = presences[key];\n                    if (user.id !== fs.user.id) {\n                        items.push(user);\n                    }\n                }\n                items.length ? fs.options.onPresences(items) : null;\n            });\n            this.presences = $firebaseArray(presencesRef);\n            return deferred.promise;\n        },\n        removeRange: function(firebaseArray, from, to) {\n            var keys = {};\n            if (to === undefined) {\n                to = firebaseArray.length;\n            }\n            for (var i = from; i < to; ++i) {\n                keys[firebaseArray.$keyAt(i)] = null;\n            }\n            return firebaseArray.$ref().update(keys);\n        },\n        clearActivities: function() {\n            var min = Number.POSITIVE_INFINITY;\n            angular.forEach(this.presences, function(presence) {\n                min = Math.min(presence.timestamp, min);\n            });\n            var activities = this.activities;\n            var from = 0,\n                to = 0;\n            angular.forEach(activities, function(item, index) {\n                if (item.timestamp < min) {\n                    to = index + 1;\n                }\n            });\n            this.removeRange(activities, from, to);\n        },\n        addActivities: function(items) {\n            if (items && items.length) {\n                var user = this.user;\n                var root = this.root; // firebase.database().ref();\n                var lastActivity = null;\n                var activitiesRef = root.child('activities');\n                angular.forEach(items, function(item) {\n                    item.userId = user.id;\n                    item.timestamp = Date.now();\n                    lastActivity = item;\n                    var activityRef = activitiesRef.push();\n                    activityRef.set(item);\n                });\n                if (lastActivity) {\n                    user.lastActivity = lastActivity;\n                    this.updateUser();\n                }\n            }\n        },\n        getUniqueActivities: function(items) {\n            items.sort(function(a, b) {\n                return b.timestamp - a.timestamp; // desc\n            });\n            var pool = {};\n            items = items.filter(function(item) {\n                if (!pool[item.id]) {\n                    return (pool[item.id] = true);\n                } else {\n                    return false;\n                }\n            });\n            items.sort(function(a, b) {\n                return a.timestamp - b.timestamp; // asc\n            });\n            return items;\n        },\n        getActivities: function() {\n            var deferred = $q.defer();\n            var fs = this;\n            var root = this.root; // firebase.database().ref();\n            var activitiesRef = root.child('activities');\n            var user = this.user;\n            var lastDate = user.timestamp;\n            activitiesRef.on('value', function(snap) {\n                var activities = snap.val(),\n                    items = [];\n                var max = Number.NEGATIVE_INFINITY;\n                for (var key in activities) {\n                    var activity = activities[key];\n                    max = Math.max(max, activity.timestamp);\n                    if (activity.userId !== fs.user.id && activity.timestamp > lastDate) {\n                        items.push(activity);\n                    }\n                }\n                lastDate = Math.max(lastDate, max);\n                items = fs.getUniqueActivities(items);\n                items.length ? fs.options.onActivities(items) : null;\n            });\n            var activities = this.activities = $firebaseArray(activitiesRef);\n            activities.$loaded().then(function() {\n                fs.clearActivities();\n                deferred.resolve();\n            }).catch(function(error) {\n                deferred.reject(error);\n            });\n            /*\n            var unwatch = activities.$watch(function(event) {\n              console.log(event);\n            });\n            // at some time in the future, we can unregister using\n            // unwatch();\n            */\n            return deferred.promise;\n        },\n    };\n    return FirebaseService;\n}]);\n\napp.factory('Cookie', ['$q', '$window', function($q, $window) {\n    function Cookie() {}\n    Cookie.TIMEOUT = 5 * 60 * 1000; // five minutes\n    Cookie._set = function(name, value, days) {\n        if (days) {\n            var date = new Date();\n            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));\n            var expires = \"; expires=\" + date.toGMTString();\n        } else {\n            var expires = \"\";\n        }\n        $window.document.cookie = name + \"=\" + value + expires + \"; path=/\";\n    }\n    Cookie.set = function(name, value, days) {\n        try {\n            var cache = [];\n            var json = JSON.stringify(value, function(key, value) {\n                if (key === 'pool') {\n                    return;\n                }\n                if (typeof value === 'object' && value !== null) {\n                    if (cache.indexOf(value) !== -1) {\n                        // Circular reference found, discard key\n                        return;\n                    }\n                    cache.push(value);\n                }\n                return value;\n            });\n            cache = null;\n            Cookie._set(name, json, days);\n        } catch (e) {\n            console.log('Cookie.set.error serializing', name, value, e);\n        }\n    };\n    Cookie.get = function(name) {\n        var cookieName = name + \"=\";\n        var ca = $window.document.cookie.split(';');\n        for (var i = 0; i < ca.length; i++) {\n            var c = ca[i];\n            while (c.charAt(0) == ' ') {\n                c = c.substring(1, c.length);\n            }\n            if (c.indexOf(cookieName) == 0) {\n                var value = c.substring(cookieName.length, c.length);\n                var model = null;\n                try {\n                    model = JSON.parse(value);\n                } catch (e) {\n                    console.log('Cookie.get.error parsing', key, e);\n                };\n                return model;\n            }\n        }\n        return null;\n    };\n    Cookie.delete = function(name) {\n        Cookie._set(name, \"\", -1);\n    };\n    Cookie.on = function(name) {\n        var deferred = $q.defer();\n        var i, interval = 1000,\n            elapsed = 0,\n            timeout = Cookie.TIMEOUT;\n\n        function checkCookie() {\n            if (elapsed > timeout) {\n                deferred.reject('timeout');\n            } else {\n                var c = Cookie.get(name);\n                if (c) {\n                    deferred.resolve(c);\n                } else {\n                    elapsed += interval;\n                    i = setTimeout(checkCookie, interval);\n                }\n            }\n        }\n        checkCookie();\n        return deferred.promise;\n    };\n    return Cookie;\n}]);\n\napp.factory('LocalStorage', ['$q', '$window', 'Cookie', function($q, $window, Cookie) {\n    function LocalStorage() {}\n\n    function isLocalStorageSupported() {\n        var supported = false;\n        try {\n            supported = 'localStorage' in $window && $window['localStorage'] !== null;\n            if (supported) {\n                $window.localStorage.setItem('test', '1');\n                $window.localStorage.removeItem('test');\n            } else {\n                supported = false;\n            }\n        } catch (e) {\n            supported = false;\n        }\n        return supported;\n    }\n    LocalStorage.isSupported = isLocalStorageSupported();\n    if (LocalStorage.isSupported) {\n        LocalStorage.set = function(name, value) {\n            try {\n                var cache = [];\n                var json = JSON.stringify(value, function(key, value) {\n                    if (key === 'pool') {\n                        return;\n                    }\n                    if (typeof value === 'object' && value !== null) {\n                        if (cache.indexOf(value) !== -1) {\n                            // Circular reference found, discard key\n                            return;\n                        }\n                        cache.push(value);\n                    }\n                    return value;\n                });\n                cache = null;\n                $window.localStorage.setItem(name, json);\n            } catch (e) {\n                console.log('LocalStorage.set.error serializing', name, value, e);\n            }\n        };\n        LocalStorage.get = function(name) {\n            var value = null;\n            if ($window.localStorage[name] !== undefined) {\n                try {\n                    value = JSON.parse($window.localStorage[name]);\n                } catch (e) {\n                    console.log('LocalStorage.get.error parsing', name, e);\n                }\n            }\n            return value;\n        };\n        LocalStorage.delete = function(name) {\n            $window.localStorage.removeItem(name);\n        };\n        LocalStorage.on = function(name) {\n            var deferred = $q.defer();\n            var i, timeout = Cookie.TIMEOUT;\n\n            function storageEvent(e) {\n                // console.log('LocalStorage.on', name, e);\n                clearTimeout(i);\n                if (e.originalEvent.key == name) {\n                    try {\n                        var value = JSON.parse(e.originalEvent.newValue); // , e.originalEvent.oldValue\n                        deferred.resolve(value);\n                    } catch (e) {\n                        console.log('LocalStorage.on.error parsing', name, e);\n                        deferred.reject('error parsing ' + name);\n                    }\n                }\n            }\n            angular.element($window).on('storage', storageEvent);\n            i = setTimeout(function() {\n                deferred.reject('timeout');\n            }, timeout);\n            return deferred.promise;\n        };\n    } else {\n        console.log('LocalStorage.unsupported switching to cookies');\n        LocalStorage.set = Cookie.set;\n        LocalStorage.get = Cookie.get;\n        LocalStorage.delete = Cookie.delete;\n        LocalStorage.on = Cookie.on;\n    }\n    return LocalStorage;\n}]);\n\napp.factory('SessionStorage', ['$q', '$window', 'Cookie', function($q, $window, Cookie) {\n    function SessionStorage() {}\n\n    function isSessionStorageSupported() {\n        var supported = false;\n        try {\n            supported = 'sessionStorage' in $window && $window.sessionStorage !== undefined;\n            if (supported) {\n                $window.sessionStorage.setItem('test', '1');\n                $window.sessionStorage.removeItem('test');\n            } else {\n                supported = false;\n            }\n        } catch (e) {\n            supported = false;\n        }\n        return supported;\n    }\n    SessionStorage.isSupported = isSessionStorageSupported();\n    if (SessionStorage.isSupported) {\n        SessionStorage.set = function(name, value) {\n            try {\n                var cache = [];\n                var json = JSON.stringify(value, function(key, value) {\n                    if (key === 'pool') {\n                        return;\n                    }\n                    if (typeof value === 'object' && value !== null) {\n                        if (cache.indexOf(value) !== -1) {\n                            // Circular reference found, discard key\n                            return;\n                        }\n                        cache.push(value);\n                    }\n                    return value;\n                });\n                cache = null;\n                $window.sessionStorage.setItem(name, json);\n            } catch (e) {\n                console.log('SessionStorage.set.error serializing', name, value, e);\n            }\n        };\n        SessionStorage.get = function(name) {\n            var value = null;\n            if ($window.sessionStorage[name] !== undefined) {\n                try {\n                    value = JSON.parse($window.sessionStorage[name]);\n                } catch (e) {\n                    console.log('SessionStorage.get.error parsing', name, e);\n                }\n            }\n            return value;\n        };\n        SessionStorage.delete = function(name) {\n            $window.sessionStorage.removeItem(name);\n        };\n        SessionStorage.on = function(name) {\n            var deferred = $q.defer();\n            var i, timeout = Cookie.TIMEOUT;\n\n            function storageEvent(e) {\n                // console.log('SessionStorage.on', name, e);\n                clearTimeout(i);\n                if (e.originalEvent.key === name) {\n                    try {\n                        var value = JSON.parse(e.originalEvent.newValue); // , e.originalEvent.oldValue\n                        deferred.resolve(value);\n                    } catch (e) {\n                        console.log('SessionStorage.on.error parsing', name, e);\n                        deferred.reject('error parsing ' + name);\n                    }\n                }\n            }\n            angular.element($window).on('storage', storageEvent);\n            i = setTimeout(function() {\n                deferred.reject('timeout');\n            }, timeout);\n            return deferred.promise;\n        };\n    } else {\n        console.log('SessionStorage.unsupported switching to cookies');\n        SessionStorage.set = Cookie.set;\n        SessionStorage.get = Cookie.get;\n        SessionStorage.delete = Cookie.delete;\n        SessionStorage.on = Cookie.on;\n    }\n    return SessionStorage;\n}]);"]}