{"version":3,"sources":["docs/js/app.js"],"names":["app","angular","module","config","$routeProvider","$locationProvider","when","title","templateUrl","controller","resolve","user","User","isLoggedOrGoTo","html5Mode","hashPrefix","$httpProvider","defaults","withCredentials","run","$rootScope","$route","$routeParams","$window","$document","$q","$timeout","closeModal","modal","index","forEach","modals","m","i","active","splice","standalone","navigator","$on","current","value","key","replace","RegExp","log","console","info","apply","arguments","addModal","modalType","params","deferred","defer","template","data","this","reject","push","scrollTo","promise","$scope","$location","State","state","ready","api","auth","model","userName","password","submit","busy","signin","then","response","success","path","$$lastRequestedPath","error","$interval","Hash","Calendar","GanttRow","serializeDate","date","pad","v","s","z","length","Array","join","yyyy","getFullYear","MM","getMonth","dd","getDate","hh","getHours","mm","getMinutes","ss","getSeconds","getRandomDay","Date","setDate","Math","floor","random","setHours","setMinutes","setSeconds","ceil","getTime","mKey","getRandomItem","day","item","id","uid","hours","activityId","row","taskId","prototype","slice","call","activity","name","budgetHours","project","type","deliveryDate","addItem","slots","add","update","updateMonths","updateItem","extend","clearItems","ranges","removeAll","months","days","intervalId","start","stop","cancel","constant","ACTIVITY","CUSTOMER","DEPARTMENT","GROUP","MANAGER","PROJECT","RESOURCE","USER","factory","pool","get","Object","defineProperties","enumerable","writable","has","undefined","getId","hash","set","newItem","p","keys","remove","oldItem","indexOf","addMany","items","removeMany","shift","each","callback","forward","reverse","sort","c","d","a","b","backward","differs","t","updatePool","pools","ArrayFrom","len","today","todayKey","clearMonth","month","tasks","fromDay","getDay","monthDays","weeks","r","$today","getKey","ganttGroups","colors","assignedHours","useBudget","customer","department","manager","resource","color","lastTaskId","canSelect","canEdit","toLowerCase","mergeSlot","slot","insertSlot","min","max","removeSlots","toggleSlots","assign","col","$key","$date","write","erase","toggle","total","copy","task","updateRanges","previous","lastDay","rKey","range","getRange","from","to","firstKey","lastKey","updateRange","previousKey","nextKey","n","canMoveRange","dir","can","first","getOffsetKey","startDate","k","moveRange","addDays","toggleOpened","opened","compress","Utils","where","serialNumber","number","toString","directive","restrict","transclude","header","link","scope","element","attributes","message","$http","$templateCache","$compile","$parse","formatLabel","string","prepend","expression","splitted","split","formatted","uniqueId","control","ngModel","required","form","placeholder","require","compile","pre","label","filter","optionLabel","options","source","field","minLength","maxLength","Number","POSITIVE_INFINITY","focus","getType","visible","getClasses","$parent","control-focus","control-success","$valid","control-error","$invalid","$submitted","$touched","control-empty","$viewValue","getMessages","$error","onClick","$eval","onValidate","button","removeListeners","off","stateClass","isBusy","successing","isSuccessing","isSuccess","errorring","isErroring","isError","stateDisabled","on","_format","templateFunction","aid","formKey","formFocus","decoration","disabled","change","onChange","onFocus","blur","onBlur","inputCols","cols","colInput","colLabel","readonly","validate","format","precision","ngDisabled","controlRow","match","validation","click","mouseover","mouseout","icon","nameHi","formKeyHi","modelHi","validationHi","requiredHi","messageHi","decorationHi","himodel","canCreate","flatten","queryable","onSelected","rows","taDisabled","templateElement","templateAttributes","html","contents","onRemove","e","getter","numberPicker","setter","onAdd","nodeRemove","nodeAdd","node","querySelectorAll","$filter","$modelValue","$setViewValue","doBlur","validateType","$formatters","$parsers","unshift","valid","String","$setValidity","isReady","idle","errors","enabled","bind","errorMessage","submitClass","submitMessage","idleMessage","busyMessage","successMessage","storage","Api","redirect","window","btoa","JSON","stringify","un","pwd","q","sso","signout","delete","service","$firebaseAuth","$firebaseObject","$firebaseArray","removeRange","firebaseArray","$keyAt","$ref","firebase","apiKey","authDomain","databaseURL","projectId","storageBucket","messagingSenderId","initializeApp","connect","presence","firstName","lastName","$signInAnonymously","remember","logged","catch","$user","timestamp","now","signup","presences","getPresences","root","database","ref","presencesRef","child","userRef","snap","val","onDisconnect","updateUser","onPresences","activities","clearActivities","addActivities","lastActivity","activitiesRef","userId","getUniqueActivities","getActivities","lastDate","NEGATIVE_INFINITY","onActivities","$loaded","url","onError","post","DEBUG","put","patch","blob","method","headers","Content-type","responseType","_service","getConfig","FirebaseService","Cookie","TIMEOUT","_set","expires","setTime","toGMTString","document","cookie","cache","json","cookieName","ca","charAt","substring","parse","checkCookie","elapsed","timeout","interval","setTimeout","LocalStorage","isSupported","supported","localStorage","setItem","removeItem","storageEvent","clearTimeout","originalEvent","newValue","SessionStorage","sessionStorage"],"mappings":"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","file":"app.min.js","sourcesContent":["/* global angular */\r\n\r\n\"use strict\";\r\n\r\nvar app = angular.module('app', ['ngRoute', 'ngMessages', 'firebase', 'jsonFormatter']);\r\n\r\napp.config(['$routeProvider', '$locationProvider', function($routeProvider, $locationProvider) {\r\n\r\n    $routeProvider.when('/', {\r\n        title: 'Homepage',\r\n        templateUrl: 'partials/home.html',\r\n        controller: 'HomeCtrl',\r\n\r\n    }).when('/signin', {\r\n        title: 'Accedi',\r\n        templateUrl: 'partials/signin.html',\r\n        controller: 'SigninCtrl',\r\n\r\n    }).when('/dashboard', {\r\n        title: 'Dashboard',\r\n        templateUrl: 'partials/dashboard.html',\r\n        controller: 'DashboardCtrl',\r\n\r\n    }).when('/user/:userId', {\r\n        title: 'User',\r\n        templateUrl: 'partials/user.html',\r\n        controller: 'UserCtrl',\r\n        resolve: {\r\n            user: ['User', function(User) {\r\n                return User.isLoggedOrGoTo('/signin');\r\n            }],\r\n        },\r\n\r\n    }).when('/404', {\r\n        title: 'Error 404',\r\n        templateUrl: 'partials/404',\r\n\r\n    });\r\n\r\n    // $routeProvider.otherwise('/'); // stream\r\n\r\n    // HTML5 MODE url writing method (false: #/anchor/use, true: /html5/url/use)\r\n    $locationProvider.html5Mode(false);\r\n    $locationProvider.hashPrefix('');\r\n\r\n}]);\r\n\r\napp.config(['$httpProvider', function($httpProvider) {\r\n    $httpProvider.defaults.withCredentials = true;\r\n}]);\r\n\r\napp.run(['$rootScope', '$route', '$routeParams', '$window', '$document', '$q', '$timeout', function($rootScope, $route, $routeParams, $window, $document, $q, $timeout) {\r\n\r\n    $rootScope.standalone = $window.navigator.standalone;\r\n\r\n    $rootScope.$on('$routeChangeSuccess', function() {\r\n        var title = $route.current.title;\r\n        angular.forEach($routeParams, function(value, key) {\r\n            title = title.replace(new RegExp(':' + key, 'g'), value);\r\n        });\r\n        $document.title = title || '';\r\n    });\r\n\r\n    $rootScope.log = function() {\r\n        if ($window.console && $window.console.info) {\r\n            $window.console.info.apply($window.console, arguments);\r\n        }\r\n    };\r\n\r\n    // MODALS\r\n    $rootScope.modals = [];\r\n    function closeModal(modal) {\r\n        var index = -1;\r\n        angular.forEach($rootScope.modals, function(m, i) {\r\n            if (m === modal) {\r\n                index = i;\r\n            }\r\n        });\r\n        if (index !== -1) {\r\n            modal.active = false;\r\n            $timeout(function() {\r\n                $rootScope.modals.splice(index, 1);\r\n            }, 500);\r\n        }\r\n    }\r\n\r\n    $rootScope.addModal = function(modalType, title, params) {\r\n        var deferred = $q.defer();\r\n        params = params || null;\r\n        var modal = {\r\n            title: 'Untitled',\r\n            controller: null,\r\n            template: null,\r\n            params: params,\r\n        };\r\n        switch (modalType) {\r\n            case 'messageModal':\r\n                modal = {\r\n                    title: title || 'Messaggio',\r\n                    controller: 'MessageModalCtrl',\r\n                    template: 'partials/modals/message',\r\n                    params: params,\r\n                };\r\n                break;\r\n        }\r\n        modal.deferred = deferred;\r\n        modal.resolve = function(data) {\r\n            closeModal(this);\r\n            modal.deferred.resolve(data, modal);\r\n        };\r\n        modal.reject = function() {\r\n            closeModal(this);\r\n            modal.deferred.reject(modal);\r\n        };\r\n        $rootScope.modals.push(modal);\r\n        angular.forEach($rootScope.modals, function(m, i) {\r\n            m.active = false;\r\n        });\r\n        $timeout(function() {\r\n            modal.active = true;\r\n            $window.scrollTo(0, 0);\r\n        }, 500);\r\n        return deferred.promise;\r\n    };\r\n\r\n}]);\n/* global angular, app */\r\n\n/* global angular, app */\r\n\r\napp.controller('RootCtrl', ['$scope', function ($scope) {\r\n\r\n}]);\r\n\r\napp.controller('HomeCtrl', ['$scope', '$location', '$timeout', 'State', function ($scope, $location, $timeout, State) {\r\n\r\n    var state = $scope.state = new State();\r\n\r\n    state.ready();\r\n\r\n}]);\r\n\r\napp.controller('DashboardCtrl', ['$scope', '$location', '$timeout', 'State', 'FirebaseApi', function ($scope, $location, $timeout, State, api) {\r\n\r\n    var state = $scope.state = new State();\r\n\r\n    var user = $scope.user = api.auth.current();\r\n\r\n    state.ready();\r\n\r\n}]);\r\n\r\napp.controller('SigninCtrl', ['$scope', '$location', '$timeout', 'State', 'FirebaseApi', function ($scope, $location, $timeout, State, api) {\r\n\r\n    var state = $scope.state = new State();\r\n\r\n    var model = $scope.model = {\r\n        userName: 'username',\r\n        password: 'password',\r\n    };\r\n\r\n    $scope.submit = function () {\r\n        if (state.busy()) {\r\n            api.auth.signin(model).then(function success(response) {                \r\n                state.success();\r\n                $timeout(function () {\r\n                    var path = $location.$$lastRequestedPath || '/dashboard';\r\n                    console.log('SigninCtrl', path, response);\r\n                    $location.path(path);\r\n                    $location.$$lastRequestedPath = null;\r\n                }, 1000);\r\n            }, function error(response) {\r\n                console.log('SigninCtrl.error', response);\r\n                state.error(response);\r\n            });\r\n        }\r\n    };\r\n\r\n}]);\r\n\r\napp.controller('DemoCtrl', ['$scope', '$interval', 'Hash', 'Calendar', 'GanttRow', function ($scope, $interval, Hash, Calendar, GanttRow) {\r\n\r\n    var row = $scope.row = new GanttRow({\r\n        activity: {\r\n            id: 1000000 + getRandom(),\r\n            name: 'Activity',\r\n            budgetHours: 10 + Math.floor(Math.random() * 50),\r\n        },\r\n        project: {\r\n            type: Math.floor(Math.random() * 5),\r\n            deliveryDate: new Date(),\r\n        },\r\n    }, []);\r\n\r\n    $scope.addItem = function () {\r\n        var item = getRandomItem();\r\n        row.slots.add(item);\r\n        row.update();\r\n        row.updateMonths();\r\n        $scope.item = item;\r\n        // console.log('addItem', item.id);\r\n        log('addItem', item.id);\r\n    };\r\n    $scope.updateItem = function () {\r\n        if ($scope.item) {\r\n            var id = $scope.item.id;\r\n            item = getRandomItem();\r\n            item = angular.extend($scope.item, item);\r\n            item.id = id;\r\n            row.slots.add(item);\r\n            row.update();\r\n            row.updateMonths();\r\n            $scope.item = item;\r\n            log('updateItem', item.id);\r\n        }\r\n    };\r\n    $scope.clearItems = function () {\r\n        row.ranges.removeAll();\r\n        row.months.removeAll();\r\n        row.days.removeAll();\r\n        row.slots.removeAll();\r\n        row.update();\r\n        row.updateMonths();\r\n        delete $scope.item;\r\n        log('clearItems');\r\n    };\r\n\r\n    var intervalId;\r\n    $scope.start = function () {\r\n        $scope.stop();\r\n        intervalId = $interval($scope.addItem, 1000 / 60);\r\n    };\r\n    $scope.stop = function () {\r\n        if (intervalId) {\r\n            $interval.cancel(intervalId);\r\n        }\r\n    };\r\n\r\n    function serializeDate(date) {\r\n        function pad(v, s, z) {\r\n            v = (v || 0) + '';\r\n            s = (s || 2);\r\n            z = (z || '0');\r\n            return v.length >= s ? v : new Array(s - v.length + 1).join(z) + v;\r\n        }\r\n        var yyyy = date.getFullYear();\r\n        var MM = date.getMonth() + 1; // getMonth() is zero-based\r\n        var dd = date.getDate();\r\n        var hh = date.getHours();\r\n        var mm = date.getMinutes();\r\n        var ss = date.getSeconds();\r\n        return yyyy + '-' + pad(MM) + '-' + pad(dd) + 'T' + pad(hh) + ':' + pad(mm) + ':' + pad(ss);\r\n    }\r\n\r\n    function getRandom() {\r\n        return 1000000 + Math.floor(Math.random() * 100000);\r\n    }\r\n\r\n    function getRandomDay() {\r\n        var oneday = (24 * 60 * 60 * 1000);\r\n        var date = new Date();\r\n        date.setDate(date.getDate() + Math.floor(Math.random() * 60));\r\n        // date.setMonth(date.getMonth() + Math.floor(Math.random() * 2));\r\n        date.setHours(0);\r\n        date.setMinutes(0);\r\n        date.setSeconds(0);\r\n        var yyyy = date.getFullYear();\r\n        var MM = date.getMonth();\r\n        var key = Math.ceil(date.getTime() / oneday);\r\n        var mKey = yyyy * 12 + MM;\r\n        return {\r\n            key: key,\r\n            mKey: mKey,\r\n            date: serializeDate(date)\r\n        };\r\n    }\r\n\r\n    var uid = 1;\r\n\r\n    function getRandomItem() {\r\n        var day = getRandomDay();\r\n        var item = {\r\n            id: uid,\r\n            hours: 1 + Math.floor(Math.random() * 6),\r\n            date: new Date(day.date),\r\n            key: day.key,\r\n            mKey: day.mKey,\r\n            activityId: row.id,\r\n        };\r\n        if (Math.floor(Math.random() * 3) === 0) {\r\n            item.taskId = 10000 + Math.floor(Math.random() * 50);\r\n        }\r\n        uid++;\r\n        return item;\r\n    }\r\n\r\n    function log() {\r\n        $scope.log = Array.prototype.slice.call(arguments);\r\n    }\r\n}]);\r\n\r\n\r\napp.constant('ganttGroups', {\r\n    ACTIVITY: 1,\r\n    CUSTOMER: 2,\r\n    DEPARTMENT: 3,\r\n    GROUP: 4,\r\n    MANAGER: 5,\r\n    PROJECT: 6,\r\n    RESOURCE: 7,\r\n    USER: 9,\r\n});\r\n\r\napp.factory('Hash', [function () {\r\n    var pools = {};\r\n\r\n    function Hash(key, pool) {\r\n        key = key || 'id';\r\n        pool = pool ? Hash.get(pool) : {};\r\n        Object.defineProperties(this, {\r\n            key: {\r\n                value: key,\r\n                enumerable: false,\r\n                writable: false\r\n            },\r\n            pool: {\r\n                value: pool,\r\n                enumerable: false,\r\n                writable: false\r\n            },\r\n            length: {\r\n                value: 0,\r\n                enumerable: false,\r\n                writable: true\r\n            }\r\n        });\r\n    }\r\n\r\n    function has(id) {\r\n        return this.pool[id] !== undefined;\r\n    }\r\n\r\n    function getId(id) {\r\n        return this.pool[id];\r\n    }\r\n\r\n    function get(item) {\r\n        var hash = this,\r\n            key = this.key;\r\n        return item ? hash.getId(item[key]) : null;\r\n    }\r\n\r\n    function set(item) {\r\n        var hash = this,\r\n            pool = this.pool,\r\n            key = this.key;\r\n        pool[item[key]] = item;\r\n        hash.push(item);\r\n        return item;\r\n    }\r\n\r\n    function add(newItem) {\r\n        var hash = this;\r\n        var item = hash.get(newItem);\r\n        if (item) {\r\n            for (var i = 0, keys = Object.keys(newItem), p; i < keys.length; i++) {\r\n                p = keys[i];\r\n                item[p] = newItem[p];\r\n            }\r\n        } else {\r\n            item = hash.set(newItem);\r\n        }\r\n        return item;\r\n    }\r\n\r\n    function remove(oldItem) {\r\n        var hash = this,\r\n            pool = this.pool,\r\n            key = this.key;\r\n        var item = hash.get(oldItem);\r\n        if (item) {\r\n            var index = hash.indexOf(item);\r\n            if (index !== -1) {\r\n                hash.splice(index, 1);\r\n            }\r\n            delete pool[item[key]];\r\n        }\r\n        return hash;\r\n    }\r\n\r\n    function addMany(items) {\r\n        var hash = this;\r\n        if (!items) {\r\n            return hash;\r\n        }\r\n        var i = 0;\r\n        while (i < items.length) {\r\n            hash.add(items[i]);\r\n            i++;\r\n        }\r\n        return hash;\r\n    }\r\n\r\n    function removeMany(items) {\r\n        var hash = this;\r\n        if (!items) {\r\n            return hash;\r\n        }\r\n        var i = 0;\r\n        while (i < items.length) {\r\n            hash.remove(items[i]);\r\n            i++;\r\n        }\r\n        return hash;\r\n    }\r\n\r\n    function removeAll() {\r\n        var hash = this,\r\n            key = hash.key,\r\n            pool = hash.pool;\r\n        var i = 0,\r\n            t = hash.length,\r\n            item;\r\n        while (hash.length) {\r\n            item = hash.shift();\r\n            delete pool[item[key]];\r\n            i++;\r\n        }\r\n        return hash;\r\n    }\r\n\r\n    function each(callback) {\r\n        var hash = this;\r\n        if (callback) {\r\n            var i = 0;\r\n            while (i < hash.length) {\r\n                callback(hash[i], i);\r\n                i++;\r\n            }\r\n        }\r\n        return hash;\r\n    }\r\n\r\n    function forward(key, reverse) {\r\n        var hash = this;\r\n        key = (key || this.key);\r\n        hash.sort(function (c, d) {\r\n            var a = reverse ? d : c;\r\n            var b = reverse ? c : d;\r\n            return a[key] - b[key];\r\n        });\r\n        return hash;\r\n    }\r\n\r\n    function backward(key) {\r\n        return this.forward(key, true);\r\n    }\r\n\r\n    function differs(hash) {\r\n        if (hash.key !== this.key || hash.length !== this.length) {\r\n            return true;\r\n        } else {\r\n            var differs = false,\r\n                i = 0,\r\n                t = this.length,\r\n                key = this.key;\r\n            while (differs && i < t) {\r\n                differs = this[i][key] !== hash[i][key];\r\n                i++;\r\n            }\r\n        }\r\n    }\r\n\r\n    function updatePool() {\r\n        var hash = this,\r\n            pool = this.pool,\r\n            key = this.key;\r\n        Object.keys(pool).forEach(function (key) {\r\n            delete pool[key];\r\n        });\r\n        angular.forEach(hash, function (item) {\r\n            pool[item[key]] = item;\r\n        });\r\n    }\r\n    Hash.get = function (pool) {\r\n        return (pools[pool] = pools[pool] || {});\r\n    };\r\n    Hash.prototype = new Array;\r\n    Hash.prototype.has = has;\r\n    Hash.prototype.getId = getId;\r\n    Hash.prototype.get = get;\r\n    Hash.prototype.set = set;\r\n    Hash.prototype.add = add;\r\n    Hash.prototype.remove = remove;\r\n    Hash.prototype.each = each;\r\n    Hash.prototype.addMany = addMany;\r\n    Hash.prototype.removeMany = removeMany;\r\n    Hash.prototype.removeAll = removeAll;\r\n    Hash.prototype.forward = forward;\r\n    Hash.prototype.backward = backward;\r\n    Hash.prototype.differs = differs;\r\n    Hash.prototype.updatePool = updatePool;\r\n    return Hash;\r\n}]);\r\n\r\napp.factory('Calendar', ['Hash', function (Hash) {\r\n    var oneday = (24 * 60 * 60 * 1000);\r\n    var today = new Date();\r\n    today.setHours(0);\r\n    today.setMinutes(0);\r\n    today.setSeconds(0);\r\n    var todayKey = Math.ceil(today.getTime() / oneday);\r\n\r\n    function ArrayFrom(len, callback) {\r\n        var a = [];\r\n        while (a.length < len) {\r\n            a.push(callback(a.length));\r\n        }\r\n        return a;\r\n    }\r\n    var months = new Hash('mKey');\r\n\r\n    function Calendar() { }\r\n    Calendar.getDate = function (day) {\r\n        if (typeof day.date.getMonth === 'function') {\r\n            return day.date;\r\n        } else {\r\n            return new Date(day.date);\r\n        }\r\n    };\r\n    Calendar.clearMonth = function (month) {\r\n        month.days.each(function (day) {\r\n            if (day) {\r\n                day.hours = 0;\r\n                day.tasks = [];\r\n            }\r\n        });\r\n    };\r\n    Calendar.getMonth = function (day) {\r\n        today = new Date();\r\n        today.setHours(0);\r\n        today.setMinutes(0);\r\n        today.setSeconds(0);\r\n        todayKey = Math.ceil(today.getTime() / oneday);\r\n        //\r\n        var date = Calendar.getDate(day);\r\n        var yyyy = date.getFullYear();\r\n        var MM = date.getMonth();\r\n        var key = Math.ceil(date.getTime() / oneday);\r\n        var mKey = yyyy * 12 + MM;\r\n        var month = months.getId(mKey);\r\n        if (!month) {\r\n            var fromDay = new Date(yyyy, MM, 1).getDay();\r\n            var monthDays = new Date(yyyy, MM + 1, 0).getDate();\r\n            var weeks = Math.ceil(monthDays / 7);\r\n            month = {\r\n                date: date,\r\n                mKey: mKey,\r\n                month: MM,\r\n                monthDays: monthDays,\r\n                fromDay: fromDay,\r\n                days: new Hash('key'),\r\n            };\r\n            month.weeks = ArrayFrom(weeks, function (r) {\r\n                var days = ArrayFrom(7, function (c) {\r\n                    var item = null;\r\n                    var d = r * 7 + c - (fromDay - 1);\r\n                    if (d >= 0 && d < monthDays) {\r\n                        var date = new Date(yyyy, MM, d + 1);\r\n                        var key = Math.ceil(date.getTime() / oneday);\r\n                        item = {\r\n                            $today: key === todayKey,\r\n                            c: c,\r\n                            r: r,\r\n                            d: d + 1,\r\n                            date: date,\r\n                            key: key,\r\n                            hours: 0,\r\n                            tasks: [],\r\n                        };\r\n                        item = month.days.add(item);\r\n                    }\r\n                    return item;\r\n                });\r\n                return {\r\n                    r: r,\r\n                    days: days,\r\n                };\r\n            });\r\n            month = months.add(month);\r\n        }\r\n        return month;\r\n    };\r\n    Calendar.getDay = function (days) {\r\n        var date = new Date(today);\r\n        date.setDate(date.getDate() + days);\r\n        return date;\r\n    };\r\n    Calendar.getKey = function (date) {\r\n        return Math.ceil(date.getTime() / oneday);\r\n    };\r\n    return Calendar;\r\n}]);\r\n\r\napp.factory('GanttRow', ['Hash', 'Calendar', 'ganttGroups', function (Hash, Calendar, ganttGroups) {\r\n    var uid = 1;\r\n\r\n    var oneday = (24 * 60 * 60 * 1000);\r\n    var today = new Date();\r\n    today.setHours(0);\r\n    today.setMinutes(0);\r\n    today.setSeconds(0);\r\n    var todayKey = Math.ceil(today.getTime() / oneday);\r\n\r\n    function GanttRow(data, colors) {\r\n        this.type = ganttGroups.ACTIVITY;\r\n        this.assignedHours = 0;\r\n        this.slots = new Hash('id');\r\n        this.days = new Hash('key');\r\n        this.months = new Hash('mKey');\r\n        this.ranges = new Hash('rKey');\r\n        this.tasks = new Hash('id'); // 'taskId'\r\n        // angular.isObject(data) ? angular.extend(this, data) : null;\r\n        if (data) {\r\n            this.id = data.activity.id;\r\n            this.name = data.activity.name;\r\n            this.budgetHours = data.activity.budgetHours;\r\n            this.useBudget = data.project.type !== 2 && data.project.type !== 4;\r\n            this.customer = data.customer;\r\n            this.department = data.department;\r\n            this.manager = data.manager;\r\n            this.project = data.project;\r\n            this.resource = data.resource;\r\n            this.color = colors[this.id % (colors.length || 1)];\r\n        }\r\n        // this.items = new Hash().fill(data.items);\r\n        this.lastTaskId = null;\r\n        this.update();\r\n    }\r\n    GanttRow.prototype = {\r\n        canSelect: function () {\r\n            return this.type === ganttGroups.ACTIVITY && this.budgetHours > 0;\r\n        },\r\n        canEdit: function () {\r\n            return this.canSelect() && this.resource.name.toLowerCase().indexOf('nondefinito') === -1;\r\n        },\r\n        mergeSlot: function (slot) {\r\n            var slots = this.slots;\r\n            if (slot.hours) {\r\n                slots.add(slot);\r\n            } else {\r\n                slots.remove(slot);\r\n            }\r\n        },\r\n        insertSlot: function (key, hours, taskId) {\r\n            var slot = null;\r\n            if (this.useBudget) {\r\n                hours = Math.min(hours, this.budgetHours - this.assignedHours);\r\n            }\r\n            hours = Math.max(0, hours);\r\n            if (hours > 0) {\r\n                var item = {\r\n                    id: 'temp-' + (uid++),\r\n                    key: key,\r\n                    date: new Date(key * oneday),\r\n                    hours: hours,\r\n                    activityId: this.id,\r\n                };\r\n                if (taskId) {\r\n                    item.taskId = taskId;\r\n                    this.lastTaskId = taskId;\r\n                }\r\n                this.slots.add(item);\r\n                slot = this.slots.getId(item.id);\r\n            }\r\n            this.update();\r\n            return slot;\r\n        },\r\n        removeSlots: function (key) {\r\n            var day = this.days.getId(key);\r\n            day.tasks.each(function (item) {\r\n                item.hours = 0;\r\n            });\r\n            var slots = day.tasks.slice();\r\n            this.slots.removeMany(slots);\r\n            this.update();\r\n            return slots;\r\n        },\r\n        toggleSlots: function (key, hours) {\r\n            if (this.days.has(key)) {\r\n                return this.removeSlots(key);\r\n            } else {\r\n                var slot = this.insertSlot(key, hours, this.lastTaskId);\r\n                return [slot];\r\n            }\r\n        },\r\n        // WRITE CANCEL DAY SLOT\r\n        assign: function (col, value) {\r\n            console.log('assign');\r\n            var slots = this.slots,\r\n                key = col.$key;\r\n            var item = {\r\n                // errore\r\n                id: 'temp-' + (uid++),\r\n                key: key,\r\n                date: col.$date,\r\n                hours: value || 0,\r\n                activityId: this.id,\r\n            };\r\n            if (value) {\r\n                slots.add(item);\r\n            } else {\r\n                slots.remove(item);\r\n            }\r\n            this.update();\r\n            return this.days.getId(key);\r\n        },\r\n        write: function (col, value, max) {\r\n            value = Math.min(value, max);\r\n            if (this.useBudget) {\r\n                value = Math.min(value, this.budgetHours - this.assignedHours);\r\n            }\r\n            value = Math.max(0, value);\r\n            if (value && !this.days.has(col.$key) && col.$date >= today) {\r\n                return this.assign(col, value);\r\n            }\r\n        },\r\n        erase: function (col, value, max) {\r\n            if (this.days.has(col.$key) && col.$date >= today) {\r\n                return this.assign(col, null);\r\n            }\r\n        },\r\n        toggle: function (col, value, max) {\r\n            if (this.days.has(col.$key)) {\r\n                return this.erase(col, value, max);\r\n            } else {\r\n                return this.write(col, value, max);\r\n            }\r\n        },\r\n        // WRITE CANCEL DAY SLOT\r\n        update: function () {\r\n            var total = 0;\r\n            var slots = this.slots,\r\n                days = this.days;\r\n            days.removeAll();\r\n            var taskId = null;\r\n            slots.each(function (item) {\r\n                taskId = item.taskId || taskId;\r\n                total += item ? item.hours : 0;\r\n                var day = days.add({\r\n                    key: item.key,\r\n                    date: item.date,\r\n                    hours: 0,\r\n                });\r\n                day.tasks = day.tasks || new Hash('id'); // 'taskId'\r\n                day.tasks.add(angular.copy(item));\r\n                day.tasks.each(function (task) {\r\n                    day.hours += task.hours;\r\n                });\r\n            });\r\n            this.lastTaskId = taskId || this.lastTaskId;\r\n            days.forward(); // sort by key       \r\n            this.assignedHours = total;\r\n            this.updateRanges();\r\n        },\r\n        updateMonths: function () {\r\n            var days = this.days,\r\n                months = this.months;\r\n            months.removeAll();\r\n            var previous;\r\n            days.each(function (item) {\r\n                var month = Calendar.getMonth(item);\r\n                if (month !== previous) {\r\n                    previous = month;\r\n                    Calendar.clearMonth(month);\r\n                }\r\n                months.add(month);\r\n                var day = month.days.getId(item.key);\r\n                if (day) {\r\n                    day.hours = item.hours;\r\n                    day.tasks = item.tasks;\r\n                }\r\n            });\r\n            months.forward(); // sort by key  \r\n        },\r\n        updateRanges: function () {\r\n            var days = this.days,\r\n                ranges = this.ranges;\r\n            ranges.removeAll();\r\n            var rKey = 0,\r\n                lastDay;\r\n            days.each(function (day, i) {\r\n                if (lastDay) {\r\n                    if (day.key - lastDay.key > 1 || day.tasks.differs(lastDay.tasks)) {\r\n                        rKey++;\r\n                    }\r\n                }\r\n                lastDay = day;\r\n                var range = ranges.add({\r\n                    rKey: rKey,\r\n                });\r\n                range.days = range.days || [];\r\n                range.days.push(day.key);\r\n            });\r\n            ranges.forward(); // sort by key   \r\n        },\r\n        getRange: function (col, from, to) {\r\n            var ranges = this.ranges,\r\n                range = null,\r\n                key = col.$key;\r\n            ranges.each(function (item) {\r\n                var index = item.days.indexOf(key);\r\n                if (index !== -1) {\r\n                    item.c = index;\r\n                    item.firstKey = Math.max(from, item.days[0]);\r\n                    item.lastKey = Math.min(to, item.days[item.days.length - 1]);\r\n                    range = item;\r\n                }\r\n            });\r\n            return range;\r\n        },\r\n        updateRange: function (col, from, to) {\r\n            var ranges = this.ranges,\r\n                range = this.getRange(col, from, to);\r\n            if (range) {\r\n                range.previousKey = null;\r\n                range.nextKey = null;\r\n                var r = range.rKey;\r\n                if (r > 0) {\r\n                    var p = ranges[r - 1];\r\n                    range.previousKey = p.days[p.days.length - 1];\r\n                }\r\n                if (r < ranges.length - 1) {\r\n                    var n = ranges[r + 1];\r\n                    range.nextKey = n.days[0];\r\n                }\r\n            }\r\n            return range;\r\n        },\r\n        canMoveRange: function (range, dir) {\r\n            // rifare !!!\r\n            var can = true;\r\n            var row = this;\r\n            var first = range.items[0];\r\n            var last = range.items[range.items.length - 1];\r\n            var key = row.getOffsetKey(first.startDate, dir);\r\n            var i = 0,\r\n                t = range.items.length;\r\n            while (i < t) {\r\n                var k = key + i;\r\n                if (k < todayKey || (row.days.getId(k) && range.items.indexOf(row.days.getId(k)) === -1)) { // sistemare!!\r\n                    can = false;\r\n                    i = t;\r\n                }\r\n                i++;\r\n            }\r\n            return can;\r\n        },\r\n        moveRange: function (range, dir) {\r\n            if (range.items.length) {\r\n                var row = this;\r\n                if (row.canMoveRange(range, dir)) {\r\n                    angular.forEach(range.items, function (item) {\r\n                        row.addDays(item, dir);\r\n                    });\r\n                    row.update();\r\n                }\r\n            }\r\n        },\r\n        addDays: function (item, days) {\r\n            // console.log('GanttRow.addDay', item, days);\r\n            var date = new Date(item.startDate);\r\n            date.setDate(date.getDate() + days);\r\n            item.date = date;\r\n            item.key = Math.ceil(date.getTime() / oneday);\r\n            return item;\r\n        },\r\n        getOffsetKey: function (date, day) {\r\n            date = new Date(date);\r\n            date.setDate(date.getDate() + day);\r\n            var key = Math.ceil(date.getTime() / oneday);\r\n            return key;\r\n        },\r\n        getHours: function (key) {\r\n            var hours = 0;\r\n            var day = this.days.getId(key);\r\n            if (day) {\r\n                day.tasks.each(function (task) {\r\n                    hours += task.hours;\r\n                });\r\n            }\r\n            return hours;\r\n        },\r\n        toggleOpened: function () {\r\n            // console.log('toggleOpened');\r\n            this.opened = !this.opened;\r\n        },\r\n        compress: function (key) {\r\n            if (!this.items.length) {\r\n                return;\r\n            }\r\n            this.items.sort(function (a, b) {\r\n                return a.key - b.key;\r\n            });\r\n            var item = Utils.where(this.items, { key: key });\r\n            item = item || this.items[0];\r\n            var index = this.items.indexOf(item);\r\n            var i = index,\r\n                t = this.items.length;\r\n            key = Math.max(key, todayKey);\r\n            // da rifare\r\n            // collezionare ore totali\r\n            // redistribuire records in base a carico giornaliero\r\n            // spostare su gantt\r\n            while (i < t) {\r\n                item = this.items[i];\r\n                item.key = key + i - index;\r\n                item.date = new Date(item.key * oneday);\r\n                i++;\r\n            }\r\n            this.update();\r\n        },\r\n    };\r\n    GanttRow.serialNumber = function (number, max) {\r\n        return new Array((1 + (max.toString().length) - (number.toString().length))).join('0');\r\n    };\r\n    return GanttRow;\r\n}]);\n/* global angular, app */\r\n\r\napp.directive('header', [function () {\r\n    return {\r\n        restrict: 'E',\r\n        templateUrl: 'partials/header',\r\n        transclude: {\r\n            'header': '?headerItems',\r\n        },\r\n        link: function (scope, element, attributes, model) {\r\n        }\r\n    };\r\n}]);\r\n\r\napp.directive('controlMessages', [function () {\r\n    return {\r\n        restrict: 'E',\r\n        templateUrl: 'partials/control-messages',\r\n        transclude: {\r\n            'message': '?messageItems',\r\n        },\r\n        link: function (scope, element, attributes, model) {\r\n        }\r\n    };\r\n}]);\r\n\r\napp.directive('control', ['$http', '$templateCache', '$compile', '$parse', function ($http, $templateCache, $compile, $parse) {\r\n    function formatLabel(string, prepend, expression) {\r\n        string = string || '';\r\n        prepend = prepend || '';\r\n        var splitted = string.split(',');\r\n        if (splitted.length > 1) {\r\n            var formatted = splitted.shift();\r\n            angular.forEach(splitted, function (value, index) {\r\n                if (expression) {\r\n                    formatted = formatted.split('{' + index + '}').join('\\' + ' + prepend + value + ' + \\'');\r\n                } else {\r\n                    formatted = formatted.split('{' + index + '}').join(prepend + value);\r\n                }\r\n            });\r\n            if (expression) {\r\n                return '\\'' + formatted + '\\'';\r\n            } else {\r\n                return formatted;\r\n            }\r\n        } else {\r\n            return prepend + string;\r\n        }\r\n    }\r\n    var uniqueId = 0;\r\n    return {\r\n        restrict: 'A',\r\n        templateUrl: function (element, attributes) {\r\n            var template = 'partials/control';\r\n            switch (attributes.control) {\r\n                case 'select':\r\n                    template = 'partials/control-select';\r\n                    break;\r\n            }\r\n            return template;\r\n        },\r\n        scope: {\r\n            ngModel: '=',\r\n            required: '=',\r\n            form: '@',\r\n            title: '@',\r\n            placeholder: '@',\r\n        },\r\n        require: 'ngModel',\r\n        link: function (scope, element, attributes, model) {\r\n            \r\n        },\r\n        compile: function (element, attributes) {\r\n            return {\r\n                pre: function (scope, element, attributes) {\r\n                    if (attributes.control === 'select') {\r\n                        var label = (attributes.label ? attributes.label : 'name');\r\n                        var key = (attributes.key ? attributes.key : 'id');\r\n                        var filter = (attributes.min ? ' | filter:gte(\\'' + key + '\\', ' + attributes.min + ')' : '');\r\n                        var optionLabel = formatLabel(label, 'item.', true);\r\n                        scope.options = attributes.number ?\r\n                            'item.' + key + ' as ' + optionLabel + ' disable when item.disabled for item in ' + attributes.source + filter :\r\n                            optionLabel + ' disable when item.disabled for item in ' + attributes.source + filter + ' track by item.' + key;\r\n                        console.log('control.compile.pre', scope.options);\r\n                    }\r\n                    var type = scope.type = attributes.control;\r\n                    var form = scope.form = scope.form || 'form';\r\n                    var title = scope.title = scope.title || 'untitled';\r\n                    var placeholder = scope.placeholder = scope.placeholder || title;\r\n                    var field = scope.field = title.replace(/[^0-9a-zA-Z]/g, \"\").split(' ').join('') + (++uniqueId);\r\n                    scope.minLength = attributes.min || 0;\r\n                    scope.maxLength = attributes.max || Number.POSITIVE_INFINITY;\r\n                    scope.focus = false;\r\n                    scope.getType = function () {\r\n                        var type = 'text';\r\n                        switch(attributes.control) {\r\n                            case 'password':\r\n                                // var form = $parse(scope.form)(scope.$parent);\r\n                                // var field = $parse(scope.form + '.' + scope.field)(scope.$parent);\r\n                                type = scope.visible ? 'text' : 'password'; \r\n                            break;\r\n                            default:\r\n                            type = attributes.control;\r\n                        }\r\n                        console.log('control.getType', type);\r\n                        return type;\r\n                    };\r\n                    scope.getClasses = function () {\r\n                        var form = $parse(scope.form)(scope.$parent);\r\n                        var field = $parse(scope.form + '.' + scope.field)(scope.$parent);\r\n                        return {\r\n                            'control-focus': scope.focus,\r\n                            'control-success': field.$valid,\r\n                            'control-error': field.$invalid && (form.$submitted || field.$touched),\r\n                            'control-empty': !field.$viewValue\r\n                        };\r\n                    };\r\n                    scope.getMessages = function () {\r\n                        var form = $parse(scope.form)(scope.$parent);\r\n                        var field = $parse(scope.form + '.' + scope.field)(scope.$parent);\r\n                        return (form.$submitted || field.$touched) && field.$error;\r\n                    };\r\n                },\r\n                // post: function (scope, element, attributes) { }\r\n            };\r\n        }\r\n        /*\r\n        compile: function(element, attributes) {\r\n            element.removeAttr('my-dir'); \r\n            element.attr('ng-hide', 'true');\r\n            return function(scope) {\r\n                $compile(element)(scope);\r\n            };\r\n        },\r\n        */\r\n    };\r\n}]);\r\n\r\napp.directive('state', ['$timeout', function ($timeout) {\r\n    return {\r\n        restrict: 'EA',\r\n        templateUrl: 'partials/state',\r\n        transclude: true,\r\n        replace: true,\r\n        scope: {\r\n            state: '=',\r\n        },\r\n        link: function (scope, element, attributes, model) {\r\n            scope.stateClass = function () {\r\n                if (scope.state.button === element) {\r\n                    var sclass = {\r\n                        busy: scope.state.isBusy,\r\n                        successing: scope.state.isSuccessing,\r\n                        success: scope.state.isSuccess,\r\n                        errorring: scope.state.isErroring,\r\n                        error: scope.state.isError,\r\n                    };\r\n                    // console.log('stateClass', sclass);\r\n                    return sclass;\r\n                } else {\r\n                    return null;\r\n                }\r\n            };\r\n            scope.stateDisabled = function () {\r\n                var disabled = (scope.state.button && scope.state.button !== element); // || scope.$parent.$eval(attributes.onValidate);\r\n                // console.log('stateDisabled', disabled);\r\n                return disabled;\r\n            };\r\n            function onClick() {\r\n                $timeout(function () {\r\n                    if (!scope.$parent.$eval(attributes.onValidate)) {\r\n                        // console.log('state.onClick', attributes.onValidate, attributes.onClick);\r\n                        scope.state.button = element;\r\n                        return scope.$parent.$eval(attributes.onClick);\r\n                    } else {\r\n                        scope.$parent.$eval('form.$setSubmitted()');\r\n                    }\r\n                });\r\n            };\r\n            function addListeners() {\r\n                element.on('touchstart click', onClick);\r\n            };\r\n            function removeListeners() {\r\n                element.off('touchstart click', onClick);\r\n            };\r\n            scope.$on('$destroy', function () {\r\n                removeListeners();\r\n            });\r\n            addListeners();\r\n        }\r\n    }\r\n}]);\r\n\r\napp.directive('controlRow', ['$http', '$templateCache', '$compile', function ($http, $templateCache, $compile) {\r\n    var aid = 0;\r\n\r\n    function _format(string, prepend, expression) {\r\n        string = string || '';\r\n        prepend = prepend || '';\r\n        var splitted = string.split(',');\r\n        if (splitted.length > 1) {\r\n            var formatted = splitted.shift();\r\n            angular.forEach(splitted, function (value, index) {\r\n                if (expression) {\r\n                    formatted = formatted.split('{' + index + '}').join('\\' + ' + prepend + value + ' + \\'');\r\n                } else {\r\n                    formatted = formatted.split('{' + index + '}').join(prepend + value);\r\n                }\r\n            });\r\n            if (expression) {\r\n                return '\\'' + formatted + '\\'';\r\n            } else {\r\n                return formatted;\r\n            }\r\n        } else {\r\n            return prepend + string;\r\n        }\r\n    }\r\n\r\n    function templateFunction(element, attributes) {\r\n        var form = attributes.form || 'Form';\r\n        var title = attributes.title || 'Untitled';\r\n        var placeholder = attributes.placeholder || title;\r\n        var name = title.replace(/[^0-9a-zA-Z]/g, \"\").split(' ').join('') + (++aid);\r\n        var formKey = form + '.' + name;\r\n        var formFocus = ' ng-focus=\"' + formKey + '.hasFocus=true\" ng-blur=\"' + formKey + '.hasFocus=false\"';\r\n        var message = '',\r\n            decoration = '',\r\n            disabled = '';\r\n        var label = (attributes.label ? attributes.label : 'name');\r\n        var key = (attributes.key ? attributes.key : 'id');\r\n        var model = attributes.model;\r\n        var change = (attributes.onChange ? ' ng-change=\"' + attributes.onChange + '\"' : '');\r\n        var focus = (attributes.onFocus ? ' ng-focus=\"' + attributes.onFocus + '\"' : '');\r\n        var blur = (attributes.onBlur ? ' ng-blur=\"' + attributes.onBlur + '\"' : '');\r\n        var inputCols = attributes.cols ? 6 : 9;\r\n        var colInput = 'col-lg-' + inputCols;\r\n        var colLabel = 'col-lg-' + (12 - inputCols);\r\n        if (attributes.cols === '12') {\r\n            colLabel = colInput = 'col-lg-12';\r\n        }\r\n        var required = (attributes.required ? ' required=\"true\"' : '');\r\n        var readonly = (attributes.readonly ? ' readonly' : '');\r\n        var options = (attributes.options ? ' ng-model-options=\"' + attributes.options + '\" ' : '');\r\n        var validate = (attributes.validate ? ' validate-type=\"' + attributes.validate + '\" ' : '');\r\n        var format = (attributes.format ? ' format=\"' + attributes.format + '\" ' : '');\r\n        var precision = (attributes.precision ? ' precision=\"' + attributes.precision + '\" ' : '');\r\n        if (attributes.disabled) {\r\n            disabled = ' disabled';\r\n        }\r\n        if (attributes.ngDisabled) {\r\n            disabled = ' ng-disabled=\"' + attributes.ngDisabled + '\"';\r\n        }\r\n        if (attributes.required) {\r\n            decoration = attributes.readonly || attributes.disabled ? '' : '<sup></sup>';\r\n        }\r\n        message = '<span ng-messages=\"' + (attributes.readonly ? '' : '(' + form + '.$submitted || ' + formKey + '.$touched) && ') + formKey + '.$error\" role=\"alert\">';\r\n        message = message + '<span ng-message=\"required\" class=\"label-error animated flash\">obbligatorio </span>';\r\n        switch (attributes.controlRow) {\r\n            case 'password':\r\n                message = message + '<span ng-message=\"minlength\" class=\"label-error animated flash\">almeno 6 caratteri </span>';\r\n                break;\r\n            case 'email':\r\n                message = message + '<span ng-message=\"email\" class=\"label-error animated flash\">valore non corretto </span>';\r\n                break;\r\n            case 'number':\r\n            case 'range':\r\n                message = message + '<span ng-message=\"positive\" class=\"label-error animated flash\">solo valori positivi </span>';\r\n                message = message + '<span ng-message=\"number\" class=\"label-error animated flash\">solo valori numerici </span>';\r\n                break;\r\n        }\r\n        if (attributes.match !== undefined) {\r\n            message = message + '<span ng-message=\"match\" class=\"label-error animated flash\">non corrispondente </span>';\r\n        }\r\n        message = message + '</span>';\r\n        var validation = ' ng-class=\"{ \\'control-focus\\': ' + formKey + '.hasFocus, \\'control-success\\': ' + formKey + '.$valid, \\'control-error\\': ' + formKey + '.$invalid && (' + form + '.$submitted || ' + formKey + '.$touched), \\'control-empty\\': !' + formKey + '.$viewValue }\"';\r\n        var template = '<div class=\"row\" ' + validation + '><label for=\"' + name + '\" class=\"' + colLabel + ' col-form-label\">' + title + decoration + '</label><div class=\"' + colInput + ' col-' + attributes.controlRow + '\">';\r\n        switch (attributes.controlRow) {\r\n            case 'static':\r\n                var click = (attributes.click ? ' ng-click=\"' + attributes.click + '\"' : '');\r\n                var mouseover = (attributes.mouseover ? ' ng-mouseover=\"' + attributes.mouseover + '\"' : '');\r\n                var mouseout = (attributes.mouseout ? ' ng-mouseover=\"' + attributes.mouseout + '\"' : '');\r\n                var icon = (attributes.icon ? '<i class=\"pull-xs-right ' + attributes.icon + '\"></i>' : '');\r\n                template += '<p class=\"form-control\" ' + click + mouseover + mouseout + '><span ng-bind-html=\"' + model + ' || \\'&nbsp;\\'\"></span>' + icon + '</p>';\r\n                break;\r\n            case 'checkbox':\r\n                template = '<div class=\"' + colInput + '\"' + validation + '><div class=\"col-xs-12\"><label class=\"custom-control custom-checkbox\">';\r\n                template += '   <input type=\"checkbox\" class=\"custom-control-input\" ng-model=\"' + model + '\">';\r\n                template += '   <span class=\"custom-control-indicator\"></span>';\r\n                template += '   <span class=\"custom-control-description\">' + title + '</span>';\r\n                template += '</label>';\r\n                // template += '<input id=\"' + name + '\" name=\"' + name + '\" type=\"checkbox\" ng-model=\"' + model + '\" ' + change + focus + blur + required + ' class=\"toggle toggle-round-flat\">';\r\n                /*\r\n                template = '<div class=\"checkbox\">';\r\n                template += '<span class=\"checkbox-label\">' + title + required +'</span>';\r\n                template += '<span class=\"switch\"><input id=\"' + name + '\" name=\"' + name + '\" type=\"checkbox\" ng-model=\"' + model + '\" ' + change + focus + blur + required + ' class=\"toggle toggle-round-flat\"><label for=\"' + name + '\"></label></span>';\r\n                template += '</div>';\r\n                */\r\n                break;\r\n            case 'yesno':\r\n                template = '<div class=\"row\" ' + validation + '><label class=\"col-lg-6 custom-control custom-checkbox\">' + title + decoration + '</label>';\r\n                template += '<div class=\"' + colLabel + '\"><label class=\"custom-control custom-checkbox\">';\r\n                template += '   <input type=\"checkbox\" class=\"custom-control-input\" ng-model=\"' + model + '\" ng-change=\"' + model + 'No=!' + model + '\">';\r\n                template += '   <span class=\"custom-control-indicator\"></span>';\r\n                template += '   <span class=\"custom-control-description\">S</span>';\r\n                template += '</label></div>';\r\n                template += '<div class=\"' + colLabel + '\"><label class=\"custom-control custom-checkbox\">';\r\n                template += '   <input type=\"checkbox\" class=\"custom-control-input\" ng-model=\"' + model + 'No\" ng-change=\"' + model + '=!' + model + 'No\">';\r\n                template += '   <span class=\"custom-control-indicator\"></span>';\r\n                template += '   <span class=\"custom-control-description\">No</span>';\r\n                template += '</label>';\r\n                // template += '<input id=\"' + name + '\" name=\"' + name + '\" type=\"checkbox\" ng-model=\"' + model + '\" ' + change + focus + blur + required + ' class=\"toggle toggle-round-flat\">';\r\n                /*\r\n                template = '<div class=\"checkbox\">';\r\n                template += '<span class=\"checkbox-label\">' + title + required +'</span>';\r\n                template += '<span class=\"switch\"><input id=\"' + name + '\" name=\"' + name + '\" type=\"checkbox\" ng-model=\"' + model + '\" ' + change + focus + blur + required + ' class=\"toggle toggle-round-flat\"><label for=\"' + name + '\"></label></span>';\r\n                template += '</div>';\r\n                */\r\n                break;\r\n            case 'switch':\r\n                if (attributes.disabled) {\r\n                    disabled = ' disabled=\"true\"';\r\n                }\r\n                if (attributes.ngDisabled) {\r\n                    disabled = ' disabled=\"' + attributes.ngDisabled + '\"';\r\n                }\r\n                template = '<div class=\"row control-switch\" ' + validation + '><label for=\"' + name + '\" class=\"' + colLabel + ' col-form-label\">' + title + decoration + '</label>';\r\n                template += '<div class=\"' + colInput + '\">';\r\n                template += '<switch name=\"' + name + '\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' on=\"S\" off=\"No\" ' + required + disabled + readonly + formFocus + '></switch>';\r\n                break;\r\n            case 'range':\r\n                validate = ' validate-type=\"number\"';\r\n                var nameHi = name + 'Hi';\r\n                var formKeyHi = form + '.' + nameHi;\r\n                var modelHi = attributes.modelHi;\r\n                var validationHi = ' ng-class=\"{ \\'control-focus\\': ' + formKeyHi + '.hasFocus, \\'control-success\\': ' + formKeyHi + '.$valid, \\'control-error\\': ' + formKeyHi + '.$invalid && (' + form + '.$submitted || ' + formKeyHi + '.$touched), \\'control-empty\\': !' + formKeyHi + '.$viewValue }\"';\r\n                var requiredHi = required;\r\n                if (attributes.requiredHi == 'true') {\r\n                    requiredHi = ' required=\"true\"';\r\n                } else if (attributes.requiredHi == 'false') {\r\n                    requiredHi = '';\r\n                }\r\n                var messageHi = ' ',\r\n                    decorationHi = ' ';\r\n                if (attributes.required && attributes.requiredHi !== 'false') {\r\n                    decorationHi = attributes.readonly || attributes.disabled ? '' : '<sup></sup>';\r\n                }\r\n                messageHi = '<span ng-messages=\"' + (attributes.readonly ? '' : '(' + form + '.$submitted || ' + formKeyHi + '.$touched) && ') + formKeyHi + '.$error\" role=\"alert\">';\r\n                messageHi = messageHi + '<span ng-message=\"required\" class=\"label-error animated flash\">obbligatorio </span>';\r\n                switch (attributes.controlRow) {\r\n                    case 'password':\r\n                        messageHi = messageHi + '<span ng-message=\"minlength\" class=\"label-error animated flash\">almeno 3 caratteri </span>';\r\n                        break;\r\n                    case 'email':\r\n                        messageHi = messageHi + '<span ng-message=\"email\" class=\"label-error animated flash\">valore non corretto </span>';\r\n                        break;\r\n                    case 'number':\r\n                    case 'range':\r\n                        messageHi = messageHi + '<span ng-message=\"positive\" class=\"label-error animated flash\">solo valori positivi </span>';\r\n                        messageHi = messageHi + '<span ng-message=\"number\" class=\"label-error animated flash\">solo valori numerici </span>';\r\n                        break;\r\n                }\r\n                if (attributes.match !== undefined) {\r\n                    messageHi = messageHi + '<span ng-message=\"match\" class=\"label-error animated flash\">non corrispondente </span>';\r\n                }\r\n                messageHi = messageHi + '</span>';\r\n                template = '<div class=\"row\"><label for=\"' + name + '\" class=\"' + colLabel + ' col-form-label\">' + title + '</label><div class=\"' + colInput + ' col-' + attributes.controlRow + '\">';\r\n                template += '<div class=\"form-control-range form-control-range-min\" ' + validation + '>' + decoration + '<input class=\"form-control\" name=\"' + name + '\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + required + disabled + readonly + formFocus + validate + format + precision + '>' + message + '</div>';\r\n                template += '<div class=\"form-control-range form-control-range-max\" ' + validationHi + '>' + decorationHi + '<input class=\"form-control\" name=\"' + nameHi + '\" ng-model=\"' + modelHi + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + requiredHi + disabled + readonly + formFocus + validate + format + precision + '>' + messageHi + '</div>';\r\n                return template + '</div></div>';\r\n                break;\r\n            case 'range-slider':\r\n                var himodel = (attributes.himodel ? ' rz-slider-high=\"' + attributes.himodel + '\" ' : '');\r\n                options = (attributes.options ? ' rz-slider-options=\"' + attributes.options + '\" ' : '');\r\n                template += '<rzslider rz-slider-model=\"' + model + '\" ' + himodel + options + '\"></rzslider>';\r\n                break;\r\n            case 'select':\r\n                var filter = (attributes.min ? ' | filter:gte(\\'' + key + '\\', ' + attributes.min + ')' : '');\r\n                var optionLabel = _format(label, 'item.', true);\r\n                var options = attributes.number ?\r\n                    'item.' + key + ' as ' + optionLabel + ' disable when item.disabled for item in ' + attributes.source + filter :\r\n                    optionLabel + ' disable when item.disabled for item in ' + attributes.source + filter + ' track by item.' + key;\r\n                template += '<select name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + ' ng-options=\"' + options + '\" ' + (attributes.number ? 'convert-to-number' : '') + required + disabled + '><option value=\"\" disabled selected hidden>' + placeholder + '</option></select>';\r\n                break;\r\n            case 'autocomplete':\r\n                var canCreate = (attributes.canCreate ? attributes.canCreate : false);\r\n                var flatten = (attributes.flatten ? attributes.flatten : false);\r\n                var queryable = (attributes.queryable ? attributes.queryable : false);\r\n                var onSelected = (attributes.onSelected ? ' on-selected=\"' + attributes.onSelected + '\"' : '');\r\n                template += '<input name=\"' + name + '\" ng-model=\"' + model + '\" type=\"hidden\" ' + (attributes.required ? 'required' : '') + '>';\r\n                template += '<div control-autocomplete=\"' + attributes.source + '\" model=\"' + model + '\" label=\"' + label + '\"  key=\"' + key + '\" can-create=\"' + canCreate + '\" flatten=\"' + flatten + '\" queryable=\"' + queryable + '\" placeholder=\"' + placeholder + '\" on-focus=\"' + formKey + '.hasFocus=true\" on-blur=\"' + formKey + '.hasFocus=false\"' + onSelected + '></div>';\r\n                break;\r\n            case 'textarea':\r\n                var rows = (attributes.rows ? attributes.rows : '1');\r\n                template += '<textarea name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" ' + required + disabled + ' rows=\"' + rows + '\"' + formFocus + '></textarea>';\r\n                break;\r\n            case 'htmltext':\r\n                var taDisabled = '';\r\n                if (attributes.disabled) {\r\n                    taDisabled = ' ta-disabled=\"true\"';\r\n                }\r\n                if (attributes.ngDisabled) {\r\n                    taDisabled = ' ta-disabled=\"' + attributes.ngDisabled + '\"';\r\n                }\r\n                template += '<div text-angular name=\"' + name + '\" ta-paste=\"doStripHtml($html)\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" ' + required + taDisabled + readonly + formFocus + (attributes.required ? ' ta-min-text=\"1\"' : '') + '></div>';\r\n                break;\r\n            case 'password':\r\n                template += '<div class=\"input-group\"><input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"{{form.' + name + ' ? \\'password\\' : \\'text\\'}}\" ng-minlength=\"6\" ' + required + disabled + formFocus + '><span class=\"input-group-addon\" ng-if=\"' + model + '\"><span class=\"icon-eye\" ng-click=\"form.' + name + ' = !form.' + name + '\"></span></span></div>';\r\n                break;\r\n            case 'email':\r\n                template += '<input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"email\" ' + required + disabled + formFocus + '>';\r\n                break;\r\n            case 'number-picker':\r\n                validate = ' validate-type=\"anynumber\"';\r\n                /*\r\n                var doSub = model + ' = ' + model + ' -1';\r\n                if (attributes.min) {\r\n                    validate += ' min=\"' + attributes.min + '\"';\r\n                    doSub = model + ' = Math.max(' + attributes.min + ', ' + model + ' -1)';\r\n                }\r\n                var doAdd = model + ' = ' + model + ' +1';\r\n                if (attributes.max) {\r\n                    validate += ' max=\"' + attributes.max + '\"';\r\n                    doAdd = model + ' = Math.min(' + attributes.max + ', ' + model + ' +1)';\r\n                }\r\n                template += '<div class=\"input-group\">';\r\n                template += '   <span class=\"input-group-btn\"><button class=\"btn btn-outline-primary\" type=\"button\" ng-click=\"(' + doSub + ')\">-</button></span>';\r\n                template += '   <input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + required + disabled + readonly + formFocus + validate + format + precision + '>';\r\n                template += '   <span class=\"input-group-btn\"><button class=\"btn btn-outline-primary\" type=\"button\" ng-click=\"(' + doAdd + ')\">+</button></span>';\r\n                template += '</div>';\r\n                */\r\n                template += '<div number-picker=\"' + model + '\" min=\"' + attributes.min + '\" max=\"' + attributes.max + '\">';\r\n                template += '   <input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + required + disabled + readonly + formFocus + validate + format + precision + '>';\r\n                template += '</div>';\r\n                break;\r\n            case 'number':\r\n                validate = ' validate-type=\"number\"';\r\n                template += '<input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + required + disabled + readonly + formFocus + validate + format + precision + '>';\r\n                break;\r\n            case 'anynumber':\r\n                validate = ' validate-type=\"anynumber\"';\r\n                template += '<input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + required + disabled + readonly + formFocus + validate + format + precision + '>';\r\n                break;\r\n            case 'date':\r\n                validate = ' validate-type=\"date\"';\r\n                format = ' format=\"dd-MM-yyyy\"';\r\n                if (attributes.disabled || attributes.readonly) {\r\n                    template += '<div class=\"input-group\"><input type=\"text\" class=\"form-control\" name=\"' + name + '\" ng-model=\"' + model + '\" placeholder=\"' + placeholder + '\" ' + required + disabled + readonly + formFocus + validate + format + '><span class=\"input-group-addon\"><i class=\"icon-calendar\"></i></span></div>';\r\n                } else {\r\n                    template += '<input type=\"date\" name=\"' + name + '\" class=\"form-control form-control-hidden\" is-open=\"flags.' + name + '\" ng-model=\"' + model + '\" placeholder=\"dd-MM-yyyy\" ' + required + disabled + readonly + formFocus + ' uib-datepicker-popup datepicker-options=\"sources.datepickerOptions\" datepicker-template-url=\"uib/template/datepicker/datepicker.html\" show-button-bar=\"false\" current-text=\"Oggi\" clear-text=\"Rimuovi\" close-text=\"Chiudi\">';\r\n                    template += '<div ng-click=\"(flags.' + name + ' = true)\" class=\"input-group disabled\"><input type=\"text\" class=\"form-control\" name=\"' + name + '\" ng-model=\"' + model + '\" placeholder=\"' + placeholder + '\" ' + required + disabled + readonly + formFocus + validate + format + '><span class=\"input-group-addon\"><i class=\"icon-calendar\"></i></span></div>';\r\n                }\r\n                break;\r\n            /*\r\n        case 'date':\r\n            placeholder = placeholder || 'dd-MM-yyyy';\r\n            template += '<input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"date\"' + required + disabled + readonly + formFocus + '>';\r\n            break;\r\n            */\r\n            case 'datetime-local':\r\n                placeholder = placeholder || 'dd-MM-yyyyTHH:mm:ss';\r\n                // placeholder == title ? placeholder = 'dd/MM/yyyyTHH:mm:ss' : null;\r\n                template += '<input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"datetime-local\"' + required + disabled + readonly + formFocus + '>';\r\n                break;\r\n            case 'text':\r\n            default:\r\n                template += '<input name=\"' + name + '\" class=\"form-control\" ng-model=\"' + model + '\" ' + change + focus + blur + options + ' placeholder=\"' + placeholder + '\" type=\"text\"' + required + disabled + readonly + formFocus + validate + format + precision + '>';\r\n                break;\r\n        }\r\n        return template + message + '</div></div>';\r\n    }\r\n    return {\r\n        restrict: 'A',\r\n        replace: true,\r\n        compile: function (templateElement, templateAttributes) {\r\n            return function (scope, element, attributes) {\r\n                element.html(templateFunction(templateElement, templateAttributes));\r\n                $compile(element.contents())(scope);\r\n            }\r\n        }\r\n    }\r\n}]);\r\n\r\napp.directive('numberPicker', ['$parse', '$timeout', function ($parse, $timeout) {\r\n    return {\r\n        restrict: 'A',\r\n        template: '<div class=\"input-group\">' +\r\n        '   <span class=\"input-group-btn\"><button class=\"btn btn-outline-primary\" type=\"button\">-</button></span>' +\r\n        '   <div ng-transclude></div>' +\r\n        '   <span class=\"input-group-btn\"><button class=\"btn btn-outline-primary\" type=\"button\">+</button></span>' +\r\n        '</div>',\r\n        replace: true,\r\n        transclude: true,\r\n        link: function (scope, element, attributes, model) {\r\n            var node = element[0];\r\n            var nodeRemove = node.querySelectorAll('.input-group-btn > .btn')[0];\r\n            var nodeAdd = node.querySelectorAll('.input-group-btn > .btn')[1];\r\n\r\n            function onRemove(e) {\r\n                var min = $parse(attributes.min)(scope);\r\n                var getter = $parse(attributes.numberPicker);\r\n                var setter = getter.assign;\r\n                $timeout(function () {\r\n                    setter(scope, Math.max(min, getter(scope) - 1));\r\n                });\r\n                // console.log('numberPicker.onRemove', min);\r\n            }\r\n\r\n            function onAdd(e) {\r\n                var max = $parse(attributes.max)(scope);\r\n                var getter = $parse(attributes.numberPicker);\r\n                var setter = getter.assign;\r\n                $timeout(function () {\r\n                    setter(scope, Math.min(max, getter(scope) + 1));\r\n                });\r\n                // console.log('numberPicker.onAdd', max);\r\n            }\r\n\r\n            function addListeners() {\r\n                angular.element(nodeRemove).on('touchstart mousedown', onRemove);\r\n                angular.element(nodeAdd).on('touchstart mousedown', onAdd);\r\n            }\r\n\r\n            function removeListeners() {\r\n                angular.element(nodeRemove).off('touchstart mousedown', onRemove);\r\n                angular.element(nodeAdd).off('touchstart mousedown', onAdd);\r\n            }\r\n            scope.$on('$destroy', function () {\r\n                removeListeners();\r\n            });\r\n            addListeners();\r\n        }\r\n    }\r\n}]);\r\n\r\n\r\n\r\napp.directive('validateType', ['$filter', function ($filter) {\r\n    return {\r\n        require: 'ngModel',\r\n        link: function (scope, element, attributes, model) {\r\n            var validateType = attributes.validateType;\r\n            var format = attributes.format || '';\r\n            var precision = attributes.precision || 2;\r\n            var focus = false;\r\n            switch (validateType) {\r\n                case 'date':\r\n                case 'datetime':\r\n                case 'datetime-local':\r\n                    model.$formatters.push(function (value) {\r\n                        if (value) {\r\n                            return $filter('date')(value, format);\r\n                        } else {\r\n                            return null;\r\n                        }\r\n                    });\r\n                    break;\r\n                case 'number':\r\n                    model.$parsers.unshift(function (value) {\r\n                        var valid = false,\r\n                            type = validateType;\r\n                        if (value !== undefined && value !== \"\") {\r\n                            valid = String(value).indexOf(Number(value).toString()) !== -1; // isFinite(value); // \r\n                            value = Number(value);\r\n                            model.$setValidity('number', valid);\r\n                            if (valid) {\r\n                                model.$setValidity('positive', value >= 0.01);\r\n                                attributes.min !== undefined ? model.$setValidity('range', value >= Number(attributes.min)) : null;\r\n                                attributes.max !== undefined ? model.$setValidity('range', value <= Number(attributes.max)) : null;\r\n                            }\r\n                            /*                             \r\n                            if (valid) {\r\n                                if (value < 0.01) {\r\n                                    valid = false;\r\n                                    type = 'positive';\r\n                                }\r\n                                if (valid && attributes.min !== undefined) {\r\n                                    valid = valid && value >= Number(attributes.min);\r\n                                    if (!valid) {\r\n                                        type = 'range';\r\n                                    }\r\n                                }\r\n                                if (valid && attributes.max !== undefined) {\r\n                                    valid = valid && value <= Number(attributes.max);\r\n                                    if (!valid) {\r\n                                        type = 'range';\r\n                                    }\r\n                                }\r\n                            }\r\n                            */\r\n                            // console.log('validateType.number', type, valid, value);\r\n                        } else {\r\n                            valid = true;\r\n                            value = Number(value);\r\n                            model.$setValidity('number', true);\r\n                            model.$setValidity('positive', true);\r\n                            attributes.min !== undefined ? model.$setValidity('range', true) : null;\r\n                            attributes.max !== undefined ? model.$setValidity('range', true) : null;\r\n                        }\r\n                        return value;\r\n                    });\r\n                    model.$formatters.push(function (value) {\r\n                        if (value) {\r\n                            return $filter('number')(value, precision) + ' ' + format;\r\n                        } else {\r\n                            return null;\r\n                        }\r\n                    });\r\n                    /*\r\n                    model.$render = function () {\r\n                        console.log('model.render', model.$modelValue);\r\n                        element[0].value = model.$modelValue ? $filter('number')(model.$modelValue, precision) + ' ' + format : ' ';\r\n                    };\r\n                    */\r\n                    break;\r\n                case 'anynumber':\r\n                    model.$parsers.unshift(function (value) {\r\n                        var valid = false,\r\n                            type = validateType;\r\n                        if (value !== undefined && value !== \"\") {\r\n                            valid = String(value).indexOf(Number(value).toString()) !== -1; // isFinite(value); // \r\n                            value = Number(value);\r\n                            model.$setValidity('number', valid);\r\n                            if (valid) {\r\n                                attributes.min !== undefined ? model.$setValidity('range', value >= Number(attributes.min)) : null;\r\n                                attributes.max !== undefined ? model.$setValidity('range', value <= Number(attributes.max)) : null;\r\n                            }\r\n                        } else {\r\n                            valid = true;\r\n                            value = Number(value);\r\n                            model.$setValidity('number', true);\r\n                            attributes.min !== undefined ? model.$setValidity('range', true) : null;\r\n                            attributes.max !== undefined ? model.$setValidity('range', true) : null;\r\n                        }\r\n                        return value;\r\n                    });\r\n                    model.$formatters.push(function (value) {\r\n                        if (value || value === 0) {\r\n                            return $filter('number')(value, precision) + ' ' + format;\r\n                        } else {\r\n                            return null;\r\n                        }\r\n                    });\r\n                    break;\r\n            }\r\n\r\n            function onFocus() {\r\n                focus = true;\r\n                if (format) {\r\n                    element[0].value = model.$modelValue || null;\r\n                    if (!model.$modelValue) {\r\n                        model.$setViewValue(null);\r\n                    }\r\n                }\r\n            }\r\n\r\n            function doBlur() {\r\n                if (format && !model.$invalid) {\r\n                    switch (validateType) {\r\n                        case 'date':\r\n                        case 'datetime':\r\n                        case 'datetime-local':\r\n                            element[0].value = model.$modelValue ? $filter('date')(model.$modelValue, format) : ' ';\r\n                            break;\r\n                        default:\r\n                            element[0].value = model.$modelValue ? $filter('number')(model.$modelValue, precision) + ' ' + format : ' ';\r\n                            break;\r\n                    }\r\n                }\r\n            }\r\n\r\n            function onBlur() {\r\n                focus = false;\r\n                doBlur();\r\n            }\r\n\r\n            function addListeners() {\r\n                element.on('focus', onFocus);\r\n                element.on('blur', onBlur);\r\n            }\r\n\r\n            function removeListeners() {\r\n                element.off('focus', onFocus);\r\n                element.off('blur', onBlur);\r\n            }\r\n            scope.$on('$destroy', function () {\r\n                removeListeners();\r\n            });\r\n            addListeners();\r\n        }\r\n    };\r\n}]);\n/* global angular, app, Autolinker */\r\n\n/* global angular, app */\r\n\r\napp.factory('State', ['$timeout', function($timeout) {\r\n    function State() {\r\n        this.isReady = false;\r\n        this.idle();\r\n    }\r\n    State.prototype = {\r\n        idle: function() {\r\n            this.isBusy = false;\r\n            this.isError = false;\r\n            this.isErroring = false;\r\n            this.isSuccess = false;\r\n            this.isSuccessing = false;\r\n            this.button = null;\r\n            this.errors = [];\r\n        },\r\n        enabled: function() {\r\n            return !this.isBusy && !this.isErroring && !this.isSuccessing;\r\n        },\r\n        busy: function() {\r\n            if (!this.isBusy) {\r\n                this.isBusy = true;\r\n                this.isError = false;\r\n                this.isErroring = false;\r\n                this.isSuccess = false;\r\n                this.isSuccessing = false;\r\n                this.errors = [];\r\n                // console.log('State.busy', this);\r\n                return true;\r\n            } else {\r\n                return false;\r\n            }\r\n        },\r\n        success: function() {\r\n            this.isBusy = false;\r\n            this.isError = false;\r\n            this.isErroring = false;\r\n            this.isSuccess = true;\r\n            this.isSuccessing = true;\r\n            this.errors = [];\r\n            $timeout(function() {\r\n                this.isSuccessing = false;\r\n                this.button = null;\r\n            }.bind(this), 1000);\r\n        },\r\n        error: function(error) {\r\n            this.isBusy = false;\r\n            this.isError = true;\r\n            this.isErroring = true;\r\n            this.isSuccess = false;\r\n            this.isSuccessing = false;\r\n            this.errors.push(error);\r\n            $timeout(function() {\r\n                this.isErroring = false;\r\n                this.button = null;\r\n            }.bind(this), 1000);\r\n        },\r\n        ready: function() {\r\n            this.isReady = true;\r\n            this.success();\r\n        },\r\n        errorMessage: function() {\r\n            return this.isError ? this.errors[this.errors.length - 1] : null;\r\n        },\r\n        submitClass: function() {\r\n            return {\r\n                busy: this.isBusy,\r\n                ready: this.isReady,\r\n                successing: this.isSuccessing,\r\n                success: this.isSuccess,\r\n                errorring: this.isErroring,\r\n                error: this.isError,\r\n            };\r\n        },\r\n        submitMessage: function(idleMessage, busyMessage, successMessage, errorMessage) {\r\n            idleMessage = idleMessage || 'Submit';\r\n            if (this.isBusy) {\r\n                return busyMessage || idleMessage;\r\n            } else if (this.isSuccess) {\r\n                return successMessage || idleMessage;\r\n            } else if (this.isError) {\r\n                return errorMessage || idleMessage;\r\n            } else {\r\n                return idleMessage;\r\n            }\r\n        },\r\n    };\r\n    return State;\r\n}]);\r\n\r\napp.factory('User', ['$q', '$location', 'LocalStorage', 'Api', function($q, $location, storage, Api) {\r\n    function User(data) {\r\n        data ? angular.extend(this, data) : null;\r\n    }\r\n    User.prototype = {};\r\n    User.current = function() {\r\n        return storage.get('user');\r\n    };\r\n    User.isLoggedOrGoTo = function(redirect) {\r\n        var deferred = $q.defer();\r\n        var q = storage.get('q');\r\n\r\n        function success(response) {\r\n            storage.set('q', window.btoa(JSON.stringify({\r\n                un: response.userName,\r\n                pwd: response.password\r\n            })));\r\n            response.password = null;\r\n            storage.set('user', { id: response.id });\r\n            deferred.resolve(response);\r\n        }\r\n\r\n        function error(response) {\r\n            deferred.reject(response);\r\n            $location.$$lastRequestedPath = $location.path();\r\n            $location.path(redirect);\r\n        }\r\n        if (q) {\r\n            Api.auth.sso(q).then(success, error);\r\n        } else {\r\n            Api.auth.current().then(success, error);\r\n        }\r\n        return deferred.promise;\r\n    };\r\n    User.signin = function(model) {\r\n        var deferred = $q.defer();\r\n        Api.auth.signin(model).then(function success(response) {\r\n            storage.set('q', window.btoa(JSON.stringify({\r\n                un: response.userName,\r\n                pwd: response.password\r\n            })));\r\n            response.password = null;\r\n            storage.set('user', { id: response.id });\r\n            deferred.resolve(response);\r\n        }, function error(response) {\r\n            deferred.reject(response);\r\n        });\r\n        return deferred.promise;\r\n    };\r\n    User.signout = function() {\r\n        var deferred = $q.defer();\r\n        var user = storage.get('user');\r\n        if (user) {\r\n            Api.auth.signout(user.id).then(function success(response) {\r\n                storage.delete('q');\r\n                storage.delete('user');\r\n                deferred.resolve(response);\r\n            }, function error(response) {\r\n                deferred.reject(response);\r\n            });\r\n        } else {\r\n            deferred.reject(null);\r\n        }\r\n        return deferred.promise;\r\n    };\r\n    return User;\r\n}]);\n/* global angular, app */\n\napp.service('FirebaseApi', ['$q', '$firebaseAuth', '$firebaseObject', '$firebaseArray', function ($q, $firebaseAuth, $firebaseObject, $firebaseArray) {\n\n    var service = this;\n\n    var firebase = window.firebase || null;\n    if (firebase) {\n        var config = {\n            apiKey: \"AIzaSyCskd8Cgzd_j7JzgEC3mEb4ir1qZFh6auQ\",\n            authDomain: \"starfish-c2b0f.firebaseapp.com\",\n            databaseURL: \"https://starfish-c2b0f.firebaseio.com\",\n            projectId: \"starfish-c2b0f\",\n            storageBucket: \"starfish-c2b0f.appspot.com\",\n            messagingSenderId: \"796739915579\"\n        };\n        firebase.initializeApp(config);\n    } else {\n        throw ('missing firebase.js');\n    }\n\n    /*\n    function FirebaseService(options) {\n        var defaults = {\n            onPresences: function(items) {\n                console.log('FirebaseService.onPresences', items.length);\n            },\n            onActivities: function(items) {\n                console.log('FirebaseService.onActivities', items.length);\n            }\n        };\n        this.options = options ? angular.extend(defaults, options) : defaults;\n        this.config = getConfig();\n    }\n    */\n\n    function removeRange(firebaseArray, from, to) {\n        var keys = {};\n        if (to === undefined) {\n            to = firebaseArray.length;\n        }\n        for (var i = from; i < to; ++i) {\n            keys[firebaseArray.$keyAt(i)] = null;\n        }\n        return firebaseArray.$ref().update(keys);\n    }\n\n    this.auth = {\n        connect: function() {            \n            var deferred = $q.defer();\n            if (service.presence) {\n                deferred.resolve(service.presence);\n            } else {\n                var presence = service.presence = {\n                    id: random,\n                    name: 'Firebase ' + random,\n                    firstName: 'Firebase',\n                    lastName: random,\n                };\n                var auth = service.auth = $firebaseAuth();\n                auth.$signInAnonymously({ remember: 'sessionOnly' }).then(function (logged) {\n                    presence.uid = logged.uid;\n                    console.log('connecting', presence);\n                    deferred.resolve(presence);\n                }).catch(function (error) {\n                    console.log('Error', error);\n                    deferred.reject(error);\n                });\n            }\n            return deferred.promise;\n        },\n        current: function () {\n            var deferred = $q.defer();\n            if (service.user) {\n                deferred.resolve(service.user);\n            } else {\n                deferred.reject();\n            }\n            return deferred.promise;\n        },\n        signin: function ($user) {\n            console.log('FirebaseService.signin', $user);\n            var deferred = $q.defer();\n            if (service.user) {\n                console.log('Signed in as', service.user);\n                deferred.resolve(service.user);\n            } else {\n                var random = 10000 + Math.floor(Math.random() * 1000);\n                var user = service.user = {\n                    id: random,\n                    name: 'Firebase ' + random,\n                    firstName: 'Firebase',\n                    lastName: random,\n                };\n                if ($user) {\n                    for (var p in user) {\n                        user[p] = $user[p] || user[p];\n                    }\n                }\n                user.timestamp = Date.now();\n                var auth = service.auth = $firebaseAuth();\n                auth.$signInAnonymously({ remember: 'sessionOnly' }).then(function (logged) {\n                    user.uid = logged.uid;\n                    console.log('Signed in as', user);\n                    deferred.resolve(user);\n                }).catch(function (error) {\n                    console.log('Error', error);\n                    deferred.reject(error);\n                });\n            }\n            return deferred.promise;\n        },\n        signup: function ($user) {\n            console.log('FirebaseService.signin', $user);\n            var deferred = $q.defer();\n            if (service.user) {\n                console.log('Signed in as', service.user);\n                deferred.resolve(service.user);\n            } else {\n                var random = 10000 + Math.floor(Math.random() * 1000);\n                var user = service.user = {\n                    id: random,\n                    name: 'Firebase ' + random,\n                    firstName: 'Firebase',\n                    lastName: random,\n                };\n                if ($user) {\n                    for (var p in user) {\n                        user[p] = $user[p] || user[p];\n                    }\n                }\n                user.timestamp = Date.now();\n                var auth = service.auth = $firebaseAuth();\n                auth.$signInAnonymously({ remember: 'sessionOnly' }).then(function (logged) {\n                    user.uid = logged.uid;\n                    console.log('Signed in as', user);\n                    deferred.resolve(user);\n                }).catch(function (error) {\n                    console.log('Error', error);\n                    deferred.reject(error);\n                });\n            }\n            return deferred.promise;\n        },\n    };\n\n    this.presences = {\n        getPresences: function () {\n            var deferred = $q.defer();\n            var user = service.user;\n            var root = service.root = firebase.database().ref();\n            var presencesRef = root.child('presences');\n            var userRef = presencesRef.push();\n            var connectedRef = root.child('.info/connected');\n            connectedRef.on('value', function (snap) {\n                if (snap.val()) {\n                    userRef.onDisconnect().remove();\n                    userRef.set(user);\n                    service.updateUser = function () {\n                        userRef.set(user);\n                    };\n                    deferred.resolve();\n                }\n            });\n            presencesRef.on('value', function (snap) {\n                // console.log('# of online users = ', snap.numChildren());\n                var presences = snap.val(),\n                    items = [];\n                for (var key in presences) {\n                    var user = presences[key];\n                    if (user.id !== service.user.id) {\n                        items.push(user);\n                    }\n                }\n                if (items.length) {\n                    service.options.onPresences(items);\n                }\n            });\n            service.presences = $firebaseArray(presencesRef);\n            return deferred.promise;\n        },\n    };\n\n    this.activities = {\n        clearActivities: function () {\n            var min = Number.POSITIVE_INFINITY;\n            angular.forEach(service.presences, function (presence) {\n                min = Math.min(presence.timestamp, min);\n            });\n            var activities = service.activities;\n            var from = 0,\n                to = 0;\n            angular.forEach(activities, function (item, index) {\n                if (item.timestamp < min) {\n                    to = index + 1;\n                }\n            });\n            removeRange(activities, from, to);\n        },\n        addActivities: function (items) {\n            if (items && items.length) {\n                var user = service.user;\n                var root = service.root; // firebase.database().ref();\n                var lastActivity = null;\n                var activitiesRef = root.child('activities');\n                angular.forEach(items, function (item) {\n                    item.userId = user.id;\n                    item.timestamp = Date.now();\n                    lastActivity = item;\n                    var activityRef = activitiesRef.push();\n                    activityRef.set(item);\n                });\n                if (lastActivity) {\n                    user.lastActivity = lastActivity;\n                    service.updateUser();\n                }\n            }\n        },\n        getUniqueActivities: function (items) {\n            items.sort(function (a, b) {\n                return b.timestamp - a.timestamp; // desc\n            });\n            var pool = {};\n            items = items.filter(function (item) {\n                if (!pool[item.id]) {\n                    return (pool[item.id] = true);\n                } else {\n                    return false;\n                }\n            });\n            items.sort(function (a, b) {\n                return a.timestamp - b.timestamp; // asc\n            });\n            return items;\n        },\n        getActivities: function () {\n            var deferred = $q.defer();\n            var root = service.root; // firebase.database().ref();\n            var activitiesRef = root.child('activities');\n            var user = service.user;\n            var lastDate = user.timestamp;\n            activitiesRef.on('value', function (snap) {\n                var activities = snap.val(),\n                    items = [];\n                var max = Number.NEGATIVE_INFINITY;\n                for (var key in activities) {\n                    var activity = activities[key];\n                    max = Math.max(max, activity.timestamp);\n                    if (activity.userId !== service.user.id && activity.timestamp > lastDate) {\n                        items.push(activity);\n                    }\n                }\n                lastDate = Math.max(lastDate, max);\n                items = service.getUniqueActivities(items);\n                if (items.length) {\n                    service.options.onActivities(items);\n                }\n            });\n            var activities = service.activities = $firebaseArray(activitiesRef);\n            activities.$loaded().then(function () {\n                service.clearActivities();\n                deferred.resolve();\n            }).catch(function (error) {\n                deferred.reject(error);\n            });\n            /*\n            var unwatch = activities.$watch(function(event) {\n              console.log(event);\n            });\n            // at some time in the future, we can unregister using\n            // unwatch();\n            */\n            return deferred.promise;\n        },\n    };\n\n}]);\n\napp.service('WebApi', ['$http', '$q', '$timeout', '$location', function ($http, $q, $timeout, $location) {\n\n    var service = this;\n\n    var _get = this.get = function (url, params) {\n        var deferred = $q.defer();\n        $http.get(url, { params: params }).then(function (response) {\n            deferred.resolve(response.data);\n        }, function (response) {\n            onError(deferred, 'get', url, { params: params }, response);\n        });\n        return deferred.promise;\n    };\n    var _post = this.post = function (url, model) {\n        var deferred = $q.defer();\n        if (service.DEBUG) {\n            console.log('Api.DEBUG', url, model);\n            deferred.resolve(model);\n        } else {\n            $http.post(url, model).then(function (response) {\n                deferred.resolve(response.data);\n            }, function (response) {\n                onError(deferred, 'post', url, model, response);\n            });\n        }\n        return deferred.promise;\n    };\n    var _put = this.put = function (url, model) {\n        var deferred = $q.defer();\n        $http.put(url, model).then(function (response) {\n            deferred.resolve(response.data);\n        }, function (response) {\n            onError(deferred, 'put', url, model, response);\n        });\n        return deferred.promise;\n    };\n    var _patch = this.patch = function (url, model) {\n        var deferred = $q.defer();\n        $http.patch(url, model).then(function (response) {\n            deferred.resolve(response.data);\n        }, function (response) {\n            onError(deferred, 'patch', url, model, response);\n        });\n        return deferred.promise;\n    };\n    var _delete = this.delete = function (url) {\n        var deferred = $q.defer();\n        $http.delete(url).then(function (response) {\n            deferred.resolve(response.data);\n        }, function (response) {\n            onError(deferred, 'delete', url, null, response);\n        });\n        return deferred.promise;\n    };\n    var _blob = this.blob = function (url, model) {\n        var deferred = $q.defer();\n        if (service.DEBUG) {\n            console.log('Api.DEBUG', url, model);\n            deferred.resolve(model);\n        } else {\n            $http({\n                url: url,\n                method: \"POST\",\n                data: model,\n                headers: {\n                    'Content-type': 'application/json'\n                },\n                responseType: 'arraybuffer',\n            }).then(function (response) {\n                deferred.resolve(response);\n            }, function (response) {\n                onError(deferred, 'post', url, model, response);\n            });\n        }\n        return deferred.promise;\n    };\n\n    this.auth = {\n        signin: _service.signin,\n        // return _post('/api/auth/login', model);\n        signout: function (userId) {\n            // return _get('/api/auth/logout/' + userId);\n        },\n        current: function () {\n            var deferred = $q.defer();\n            if (_service.user) {\n                deferred.resolve(_service.user);\n            } else {\n                deferred.reject();\n            }\n            return deferred.promise;\n            // return _get('/api/auth/current/');\n        },\n    };\n\n}]);\n\napp.factory('FirebaseService', ['$q', '$firebaseAuth', '$firebaseObject', '$firebaseArray', function ($q, $firebaseAuth, $firebaseObject, $firebaseArray) {\n\n    var service = this;\n\n    var firebase = window.firebase || null;\n\n    if (!firebase) {\n        throw ('missing firebase.js');\n    }\n\n    var config = null;\n\n    function getConfig() {\n        if (!config) {\n            // Initialize the Firebase SDK\n            config = {\n                apiKey: \"AIzaSyCskd8Cgzd_j7JzgEC3mEb4ir1qZFh6auQ\",\n                authDomain: \"starfish-c2b0f.firebaseapp.com\",\n                databaseURL: \"https://starfish-c2b0f.firebaseio.com\",\n                projectId: \"starfish-c2b0f\",\n                storageBucket: \"starfish-c2b0f.appspot.com\",\n                messagingSenderId: \"796739915579\"\n            };\n            firebase.initializeApp(config);\n        }\n        return config;\n    }\n\n    function FirebaseService(options) {\n        var defaults = {\n            onPresences: function (items) {\n                console.log('FirebaseService.onPresences', items.length);\n            },\n            onActivities: function (items) {\n                console.log('FirebaseService.onActivities', items.length);\n            }\n        };\n        this.options = options ? angular.extend(defaults, options) : defaults;\n        this.config = getConfig();\n    }\n\n    function removeRange(firebaseArray, from, to) {\n        var keys = {};\n        if (to === undefined) {\n            to = firebaseArray.length;\n        }\n        for (var i = from; i < to; ++i) {\n            keys[firebaseArray.$keyAt(i)] = null;\n        }\n        return firebaseArray.$ref().update(keys);\n    }\n\n    FirebaseService.prototype = {\n        signin: function ($user) {\n            console.log('FirebaseService.signin', $user);\n            var deferred = $q.defer();\n            if (this.user) {\n                console.log('Signed in as', this.user);\n                deferred.resolve(this.user);\n            } else {\n                var random = 10000 + Math.floor(Math.random() * 1000);\n                var user = this.user = {\n                    id: random,\n                    name: 'Firebase ' + random,\n                    firstName: 'Firebase',\n                    lastName: random,\n                };\n                if ($user) {\n                    for (var p in user) {\n                        user[p] = $user[p] || user[p];\n                    }\n                }\n                user.timestamp = Date.now();\n                var auth = this.auth = $firebaseAuth();\n                auth.$signInAnonymously({ remember: 'sessionOnly' }).then(function (logged) {\n                    user.uid = logged.uid;\n                    console.log('Signed in as', user);\n                    deferred.resolve(user);\n                }).catch(function (error) {\n                    console.log('Error', error);\n                    deferred.reject(error);\n                });\n            }\n            return deferred.promise;\n        },\n        getPresences: function () {\n            var deferred = $q.defer();\n            var user = this.user;\n            var root = this.root = firebase.database().ref();\n            var presencesRef = root.child('presences');\n            var userRef = presencesRef.push();\n            var connectedRef = root.child('.info/connected');\n            connectedRef.on('value', function (snap) {\n                if (snap.val()) {\n                    userRef.onDisconnect().remove();\n                    userRef.set(user);\n                    service.updateUser = function () {\n                        userRef.set(user);\n                    };\n                    deferred.resolve();\n                }\n            });\n            presencesRef.on('value', function (snap) {\n                // console.log('# of online users = ', snap.numChildren());\n                var presences = snap.val(),\n                    items = [];\n                for (var key in presences) {\n                    var user = presences[key];\n                    if (user.id !== service.user.id) {\n                        items.push(user);\n                    }\n                }\n                if (items.length) {\n                    service.options.onPresences(items);\n                }\n            });\n            this.presences = $firebaseArray(presencesRef);\n            return deferred.promise;\n        },\n        clearActivities: function () {\n            var min = Number.POSITIVE_INFINITY;\n            angular.forEach(this.presences, function (presence) {\n                min = Math.min(presence.timestamp, min);\n            });\n            var activities = this.activities;\n            var from = 0,\n                to = 0;\n            angular.forEach(activities, function (item, index) {\n                if (item.timestamp < min) {\n                    to = index + 1;\n                }\n            });\n            removeRange(activities, from, to);\n        },\n        addActivities: function (items) {\n            if (items && items.length) {\n                var user = this.user;\n                var root = this.root; // firebase.database().ref();\n                var lastActivity = null;\n                var activitiesRef = root.child('activities');\n                angular.forEach(items, function (item) {\n                    item.userId = user.id;\n                    item.timestamp = Date.now();\n                    lastActivity = item;\n                    var activityRef = activitiesRef.push();\n                    activityRef.set(item);\n                });\n                if (lastActivity) {\n                    user.lastActivity = lastActivity;\n                    service.updateUser();\n                }\n            }\n        },\n        getUniqueActivities: function (items) {\n            items.sort(function (a, b) {\n                return b.timestamp - a.timestamp; // desc\n            });\n            var pool = {};\n            items = items.filter(function (item) {\n                if (!pool[item.id]) {\n                    return (pool[item.id] = true);\n                } else {\n                    return false;\n                }\n            });\n            items.sort(function (a, b) {\n                return a.timestamp - b.timestamp; // asc\n            });\n            return items;\n        },\n        getActivities: function () {\n            var deferred = $q.defer();\n            var root = this.root; // firebase.database().ref();\n            var activitiesRef = root.child('activities');\n            var user = this.user;\n            var lastDate = user.timestamp;\n            activitiesRef.on('value', function (snap) {\n                var activities = snap.val(),\n                    items = [];\n                var max = Number.NEGATIVE_INFINITY;\n                for (var key in activities) {\n                    var activity = activities[key];\n                    max = Math.max(max, activity.timestamp);\n                    if (activity.userId !== service.user.id && activity.timestamp > lastDate) {\n                        items.push(activity);\n                    }\n                }\n                lastDate = Math.max(lastDate, max);\n                items = service.getUniqueActivities(items);\n                if (items.length) {\n                    service.options.onActivities(items);\n                }\n            });\n            var activities = this.activities = $firebaseArray(activitiesRef);\n            activities.$loaded().then(function () {\n                service.clearActivities();\n                deferred.resolve();\n            }).catch(function (error) {\n                deferred.reject(error);\n            });\n            /*\n            var unwatch = activities.$watch(function(event) {\n              console.log(event);\n            });\n            // at some time in the future, we can unregister using\n            // unwatch();\n            */\n            return deferred.promise;\n        },\n    };\n    return FirebaseService;\n}]);\n\napp.factory('Cookie', ['$q', '$window', function ($q, $window) {\n    function Cookie() { }\n    Cookie.TIMEOUT = 5 * 60 * 1000; // five minutes\n    Cookie._set = function (name, value, days) {\n        var expires;\n        if (days) {\n            var date = new Date();\n            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));\n            expires = '; expires=' + date.toGMTString();\n        } else {\n            expires = '';\n        }\n        $window.document.cookie = name + '=' + value + expires + '; path=/';\n    };\n    Cookie.set = function (name, value, days) {\n        try {\n            var cache = [];\n            var json = JSON.stringify(value, function (key, value) {\n                if (key === 'pool') {\n                    return;\n                }\n                if (typeof value === 'object' && value !== null) {\n                    if (cache.indexOf(value) !== -1) {\n                        // Circular reference found, discard key\n                        return;\n                    }\n                    cache.push(value);\n                }\n                return value;\n            });\n            cache = null;\n            Cookie._set(name, json, days);\n        } catch (e) {\n            console.log('Cookie.set.error serializing', name, value, e);\n        }\n    };\n    Cookie.get = function (name) {\n        var cookieName = name + \"=\";\n        var ca = $window.document.cookie.split(';');\n        for (var i = 0; i < ca.length; i++) {\n            var c = ca[i];\n            while (c.charAt(0) == ' ') {\n                c = c.substring(1, c.length);\n            }\n            if (c.indexOf(cookieName) === 0) {\n                var value = c.substring(cookieName.length, c.length);\n                var model = null;\n                try {\n                    model = JSON.parse(value);\n                } catch (e) {\n                    console.log('Cookie.get.error parsing', key, e);\n                }\n                return model;\n            }\n        }\n        return null;\n    };\n    Cookie.delete = function (name) {\n        Cookie._set(name, \"\", -1);\n    };\n    Cookie.on = function (name) {\n        var deferred = $q.defer();\n        var i, interval = 1000,\n            elapsed = 0,\n            timeout = Cookie.TIMEOUT;\n\n        function checkCookie() {\n            if (elapsed > timeout) {\n                deferred.reject('timeout');\n            } else {\n                var c = Cookie.get(name);\n                if (c) {\n                    deferred.resolve(c);\n                } else {\n                    elapsed += interval;\n                    i = setTimeout(checkCookie, interval);\n                }\n            }\n        }\n        checkCookie();\n        return deferred.promise;\n    };\n    return Cookie;\n}]);\n\napp.factory('LocalStorage', ['$q', '$window', 'Cookie', function ($q, $window, Cookie) {\n    function LocalStorage() { }\n\n    function isLocalStorageSupported() {\n        var supported = false;\n        try {\n            supported = 'localStorage' in $window && $window.localStorage !== null;\n            if (supported) {\n                $window.localStorage.setItem('test', '1');\n                $window.localStorage.removeItem('test');\n            } else {\n                supported = false;\n            }\n        } catch (e) {\n            supported = false;\n        }\n        return supported;\n    }\n    LocalStorage.isSupported = isLocalStorageSupported();\n    if (LocalStorage.isSupported) {\n        LocalStorage.set = function (name, value) {\n            try {\n                var cache = [];\n                var json = JSON.stringify(value, function (key, value) {\n                    if (key === 'pool') {\n                        return;\n                    }\n                    if (typeof value === 'object' && value !== null) {\n                        if (cache.indexOf(value) !== -1) {\n                            // Circular reference found, discard key\n                            return;\n                        }\n                        cache.push(value);\n                    }\n                    return value;\n                });\n                cache = null;\n                $window.localStorage.setItem(name, json);\n            } catch (e) {\n                console.log('LocalStorage.set.error serializing', name, value, e);\n            }\n        };\n        LocalStorage.get = function (name) {\n            var value = null;\n            if ($window.localStorage[name] !== undefined) {\n                try {\n                    value = JSON.parse($window.localStorage[name]);\n                } catch (e) {\n                    console.log('LocalStorage.get.error parsing', name, e);\n                }\n            }\n            return value;\n        };\n        LocalStorage.delete = function (name) {\n            $window.localStorage.removeItem(name);\n        };\n        LocalStorage.on = function (name) {\n            var deferred = $q.defer();\n            var i, timeout = Cookie.TIMEOUT;\n\n            function storageEvent(e) {\n                // console.log('LocalStorage.on', name, e);\n                clearTimeout(i);\n                if (e.originalEvent.key == name) {\n                    try {\n                        var value = JSON.parse(e.originalEvent.newValue); // , e.originalEvent.oldValue\n                        deferred.resolve(value);\n                    } catch (error) {\n                        console.log('LocalStorage.on.error parsing', name, error);\n                        deferred.reject('error parsing ' + name);\n                    }\n                }\n            }\n            angular.element($window).on('storage', storageEvent);\n            i = setTimeout(function () {\n                deferred.reject('timeout');\n            }, timeout);\n            return deferred.promise;\n        };\n    } else {\n        console.log('LocalStorage.unsupported switching to cookies');\n        LocalStorage.set = Cookie.set;\n        LocalStorage.get = Cookie.get;\n        LocalStorage.delete = Cookie.delete;\n        LocalStorage.on = Cookie.on;\n    }\n    return LocalStorage;\n}]);\n\napp.factory('SessionStorage', ['$q', '$window', 'Cookie', function ($q, $window, Cookie) {\n    function SessionStorage() { }\n\n    function isSessionStorageSupported() {\n        var supported = false;\n        try {\n            supported = 'sessionStorage' in $window && $window.sessionStorage !== undefined;\n            if (supported) {\n                $window.sessionStorage.setItem('test', '1');\n                $window.sessionStorage.removeItem('test');\n            } else {\n                supported = false;\n            }\n        } catch (e) {\n            supported = false;\n        }\n        return supported;\n    }\n    SessionStorage.isSupported = isSessionStorageSupported();\n    if (SessionStorage.isSupported) {\n        SessionStorage.set = function (name, value) {\n            try {\n                var cache = [];\n                var json = JSON.stringify(value, function (key, value) {\n                    if (key === 'pool') {\n                        return;\n                    }\n                    if (typeof value === 'object' && value !== null) {\n                        if (cache.indexOf(value) !== -1) {\n                            // Circular reference found, discard key\n                            return;\n                        }\n                        cache.push(value);\n                    }\n                    return value;\n                });\n                cache = null;\n                $window.sessionStorage.setItem(name, json);\n            } catch (e) {\n                console.log('SessionStorage.set.error serializing', name, value, e);\n            }\n        };\n        SessionStorage.get = function (name) {\n            var value = null;\n            if ($window.sessionStorage[name] !== undefined) {\n                try {\n                    value = JSON.parse($window.sessionStorage[name]);\n                } catch (e) {\n                    console.log('SessionStorage.get.error parsing', name, e);\n                }\n            }\n            return value;\n        };\n        SessionStorage.delete = function (name) {\n            $window.sessionStorage.removeItem(name);\n        };\n        SessionStorage.on = function (name) {\n            var deferred = $q.defer();\n            var i, timeout = Cookie.TIMEOUT;\n\n            function storageEvent(e) {\n                // console.log('SessionStorage.on', name, e);\n                clearTimeout(i);\n                if (e.originalEvent.key === name) {\n                    try {\n                        var value = JSON.parse(e.originalEvent.newValue); // , e.originalEvent.oldValue\n                        deferred.resolve(value);\n                    } catch (error) {\n                        console.log('SessionStorage.on.error parsing', name, error);\n                        deferred.reject('error parsing ' + name);\n                    }\n                }\n            }\n            angular.element($window).on('storage', storageEvent);\n            i = setTimeout(function () {\n                deferred.reject('timeout');\n            }, timeout);\n            return deferred.promise;\n        };\n    } else {\n        console.log('SessionStorage.unsupported switching to cookies');\n        SessionStorage.set = Cookie.set;\n        SessionStorage.get = Cookie.get;\n        SessionStorage.delete = Cookie.delete;\n        SessionStorage.on = Cookie.on;\n    }\n    return SessionStorage;\n}]);"]}