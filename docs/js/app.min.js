"use strict";var app=angular.module("app",["ngRoute","jsonFormatter"]);app.controller("DemoCtrl",["$scope","$interval","Hash","Calendar","GanttRow",function(t,e,a,n,s){function r(t){function e(t,e,a){return t=(t||0)+"",e=e||2,a=a||"0",t.length>=e?t:new Array(e-t.length+1).join(a)+t}var a=t.getFullYear(),n=t.getMonth()+1,s=t.getDate(),r=t.getHours(),i=t.getMinutes(),o=t.getSeconds();return a+"-"+e(n)+"-"+e(s)+"T"+e(r)+":"+e(i)+":"+e(o)}function i(){var t=new Date;t.setDate(t.getDate()+Math.floor(60*Math.random())),t.setHours(0),t.setMinutes(0),t.setSeconds(0);var e=t.getFullYear(),a=t.getMonth();return{key:Math.ceil(t.getTime()/864e5),mKey:12*e+a,date:r(t)}}function o(){var t=i(),e={id:l,hours:1+Math.floor(6*Math.random()),date:new Date(t.date),key:t.key,mKey:t.mKey,activityId:h.id};return 0==Math.floor(3*Math.random())&&(e.taskId=1e4+Math.floor(50*Math.random())),l++,e}function u(){t.log=Array.prototype.slice.call(arguments)}var h=t.row=new s({activity:{id:1e6+function(){return 1e6+Math.floor(1e5*Math.random())}(),name:"Activity",budgetHours:10+Math.floor(50*Math.random())},project:{type:Math.floor(5*Math.random()),deliveryDate:new Date}},[]);t.addItem=function(){var e=o();h.slots.add(e),h.update(),h.updateMonths(),t.item=e,u("addItem",e.id)},t.updateItem=function(){if(t.item){var e=t.item.id;item=o(),item=angular.extend(t.item,item),item.id=e,h.slots.add(item),h.update(),h.updateMonths(),t.item=item,u("updateItem",item.id)}},t.clearItems=function(){h.ranges.removeAll(),h.months.removeAll(),h.days.removeAll(),h.slots.removeAll(),h.update(),h.updateMonths(),delete t.item,u("clearItems")};var d;t.start=function(){t.stop(),d=e(t.addItem,1e3/60)},t.stop=function(){d&&e.cancel(d)};var l=1}]),app.constant("ganttGroups",{ACTIVITY:1,CUSTOMER:2,DEPARTMENT:3,GROUP:4,MANAGER:5,PROJECT:6,RESOURCE:7,USER:9}),app.factory("Hash",[function(){function t(e,a){e=e||"id",a=a?t.get(a):{},Object.defineProperties(this,{key:{value:e,enumerable:!1,writable:!1},pool:{value:a,enumerable:!1,writable:!1},length:{value:0,enumerable:!1,writable:!0}})}function e(t){return void 0!==this.pool[t]}function a(t){return this.pool[t]}function n(t){var e=this,a=this.key;return t?e.getId(t[a]):null}function s(t){var e=this;return this.pool[t[this.key]]=t,e.push(t),t}function r(t){var e=this,a=e.get(t);if(a)for(var n,s=0,r=Object.keys(t);s<r.length;s++)n=r[s],a[n]=t[n];else a=e.set(t);return a}function i(t){var e=this,a=this.pool,n=this.key,s=e.get(t);if(s){var r=e.indexOf(s);-1!==r&&e.splice(r,1),delete a[s[n]]}return e}function o(t){var e=this;if(!t)return e;for(var a=0;a<t.length;)e.add(t[a]),a++;return e}function u(t){var e=this;if(!t)return e;for(var a=0;a<t.length;)e.remove(t[a]),a++;return e}function h(){var t,e=this,a=e.key,n=e.pool,s=0;for(e.length;e.length;)t=e.shift(),delete n[t[a]],s++;return e}function d(t){var e=this;if(t)for(var a=0;a<e.length;)t(e[a],a),a++;return e}function l(t,e){var a=this,t=t||this.key;return a.sort(function(a,n){var s=e?n:a,r=e?a:n;return s[t]-r[t]}),a}function c(t){return this.forward(t,!0)}function f(t){if(t.key!==this.key||t.length!==this.length)return!0;for(var e=!1,a=0,n=this.length,s=this.key;e&&a<n;)e=this[a][s]!==t[a][s],a++}function y(){var t=this,e=this.pool,a=this.key;Object.keys(e).forEach(function(t){delete e[t]}),angular.forEach(t,function(t){e[t[a]]=t})}var g={};return t.get=function(t){return g[t]=g[t]||{}},t.prototype=new Array,t.prototype.has=e,t.prototype.getId=a,t.prototype.get=n,t.prototype.set=s,t.prototype.add=r,t.prototype.remove=i,t.prototype.each=d,t.prototype.addMany=o,t.prototype.removeMany=u,t.prototype.removeAll=h,t.prototype.forward=l,t.prototype.backward=c,t.prototype.differs=f,t.prototype.updatePool=y,t}]),app.factory("Calendar",["Hash",function(t){function e(t,e){for(var a=[];a.length<t;)a.push(e(a.length));return a}function a(){}var n=new Date;n.setHours(0),n.setMinutes(0),n.setSeconds(0);var s=Math.ceil(n.getTime()/864e5),r=new t("mKey");return a.getDate=function(t){return"function"==typeof t.date.getMonth?t.date:new Date(t.date)},a.clearMonth=function(t){t.days.each(function(t){t&&(t.hours=0,t.tasks=[])})},a.getMonth=function(i){n=new Date,n.setHours(0),n.setMinutes(0),n.setSeconds(0),s=Math.ceil(n.getTime()/864e5);var o=a.getDate(i),u=o.getFullYear(),h=o.getMonth(),d=(Math.ceil(o.getTime()/864e5),12*u+h),l=r.getId(d);if(!l){var c=new Date(u,h,1).getDay(),f=new Date(u,h+1,0).getDate(),y=Math.ceil(f/7),l={date:o,mKey:d,month:h,monthDays:f,fromDay:c,days:new t("key")};l.weeks=e(y,function(t){var a=e(7,function(e){var a=null,n=7*t+e-(c-1);if(n>=0&&n<f){var r=new Date(u,h,n+1),i=Math.ceil(r.getTime()/864e5);a={$today:i===s,c:e,r:t,d:n+1,date:r,key:i,hours:0,tasks:[]},a=l.days.add(a)}return a});return{r:t,days:a}}),l=r.add(l)}return l},a.getDay=function(t){var e=new Date(n);return e.setDate(e.getDate()+t),e},a.getKey=function(t){return Math.ceil(t.getTime()/864e5)},a}]),app.factory("GanttRow",["Hash","Calendar","ganttGroups",function(t,e,a){function n(e,n){this.type=a.ACTIVITY,this.assignedHours=0,this.slots=new t("id"),this.days=new t("key"),this.months=new t("mKey"),this.ranges=new t("rKey"),this.tasks=new t("id"),e&&(this.id=e.activity.id,this.name=e.activity.name,this.budgetHours=e.activity.budgetHours,this.useBudget=2!==e.project.type&&4!==e.project.type,this.customer=e.customer,this.department=e.department,this.manager=e.manager,this.project=e.project,this.resource=e.resource,this.color=n[this.id%(n.length||1)]),this.lastTaskId=null,this.update()}var s=1;var r=new Date;r.setHours(0),r.setMinutes(0),r.setSeconds(0);var i=Math.ceil(r.getTime()/864e5);return n.prototype={canSelect:function(){return this.type===a.ACTIVITY&&this.budgetHours>0},canEdit:function(){return this.canSelect()&&-1===this.resource.name.toLowerCase().indexOf("nondefinito")},mergeSlot:function(t){var e=this.slots;t.hours?e.add(t):e.remove(t)},insertSlot:function(t,e,a){var n=null;if(this.useBudget&&(e=Math.min(e,this.budgetHours-this.assignedHours)),(e=Math.max(0,e))>0){var r={id:"temp-"+s++,key:t,date:new Date(864e5*t),hours:e,activityId:this.id};a&&(r.taskId=a,this.lastTaskId=a),this.slots.add(r),n=this.slots.getId(r.id)}return this.update(),n},removeSlots:function(t){var e=this.days.getId(t);e.tasks.each(function(t){t.hours=0});var a=e.tasks.slice();return this.slots.removeMany(a),this.update(),a},toggleSlots:function(t,e){return this.days.has(t)?this.removeSlots(t):[this.insertSlot(t,e,this.lastTaskId)]},assign:function(t,e){console.log("assign");var a=this.slots,n=t.$key,r={id:"temp-"+s++,key:n,date:t.$date,hours:e||0,activityId:this.id};return e?a.add(r):a.remove(r),this.update(),this.days.getId(n)},write:function(t,e,a){if(e=Math.min(e,a),this.useBudget&&(e=Math.min(e,this.budgetHours-this.assignedHours)),(e=Math.max(0,e))&&!this.days.has(t.$key)&&t.$date>=r)return this.assign(t,e)},erase:function(t,e,a){if(this.days.has(t.$key)&&t.$date>=r)return this.assign(t,null)},toggle:function(t,e,a){return this.days.has(t.$key)?this.erase(t,e,a):this.write(t,e,a)},update:function(){var e=0,a=this.slots,n=this.days;n.removeAll();var s=null;a.each(function(a){s=a.taskId||s,e+=a?a.hours:0;var r=n.add({key:a.key,date:a.date,hours:0});r.tasks=r.tasks||new t("id"),r.tasks.add(angular.copy(a)),r.tasks.each(function(t){r.hours+=t.hours})}),this.lastTaskId=s||this.lastTaskId,n.forward(),this.assignedHours=e,this.updateRanges()},updateMonths:function(){var t=this.days,a=this.months;a.removeAll();var n;t.each(function(t){var s=e.getMonth(t);s!==n&&(n=s,e.clearMonth(s)),a.add(s);var r=s.days.getId(t.key);r&&(r.hours=t.hours,r.tasks=t.tasks)}),a.forward()},updateRanges:function(){var t=this.days,e=this.ranges;e.removeAll();var a,n=0;t.each(function(t,s){a&&(t.key-a.key>1||t.tasks.differs(a.tasks))&&n++,a=t;var r=e.add({rKey:n});r.days=r.days||[],r.days.push(t.key)}),e.forward()},getRange:function(t,e,a){var n=this.ranges,s=null,r=t.$key;return n.each(function(t){var n=t.days.indexOf(r);-1!==n&&(t.c=n,t.firstKey=Math.max(e,t.days[0]),t.lastKey=Math.min(a,t.days[t.days.length-1]),s=t)}),s},updateRange:function(t,e,a){var n=this.ranges,s=this.getRange(t,e,a);if(s){s.previousKey=null,s.nextKey=null;var r=s.rKey;if(r>0){var i=n[r-1];s.previousKey=i.days[i.days.length-1]}if(r<n.length-1){var o=n[r+1];s.nextKey=o.days[0]}}return s},canMoveRange:function(t,e){for(var a=!0,n=this,s=t.items[0],r=(t.items[t.items.length-1],n.getOffsetKey(s.startDate,e)),o=0,u=t.items.length;o<u;){var h=r+o;(h<i||n.days.getId(h)&&-1===t.items.indexOf(n.days.getId(h)))&&(a=!1,o=u),o++}return a},moveRange:function(t,e){if(t.items.length){var a=this;a.canMoveRange(t,e)&&(angular.forEach(t.items,function(t){a.addDays(t,e)}),a.update())}},addDays:function(t,e){var a=new Date(t.startDate);return a.setDate(a.getDate()+e),t.date=a,t.key=Math.ceil(a.getTime()/864e5),t},getOffsetKey:function(t,e){var t=new Date(t);return t.setDate(t.getDate()+e),Math.ceil(t.getTime()/864e5)},getHours:function(t){var e=0,a=this.days.getId(t);return a&&a.tasks.each(function(t){e+=t.hours}),e},toggleOpened:function(){this.opened=!this.opened},compress:function(t){if(this.items.length){this.items.sort(function(t,e){return t.key-e.key});var e=Utils.where(this.items,{key:t});e=e||this.items[0];var a=this.items.indexOf(e),n=a,s=this.items.length;for(t=Math.max(t,i);n<s;){var e=this.items[n];e.key=t+n-a,e.date=new Date(864e5*e.key),n++}this.update()}}},n.serialNumber=function(t,e){return new Array(1+e.toString().length-t.toString().length).join("0")},n}]);
//# sourceMappingURL=app.min.js.map
